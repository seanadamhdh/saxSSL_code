---
title: "BDF Frischprobennahme"
output: html_notebook
---
#setup
```{r,echo=F, message=FALSE, warning=FALSE, r,echo=F}
# set root directory path
# So script can easily be used on different devices. But does not change working directroy for project
#root_dir="/home/hydropedo/Documents"
root_dir="C://Users/adam/Documents"
source(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/packages.R"))

# load functions from soliTOCreadR package manually (package not yet fully functional)
source(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/soliTOC_readR.R"))

source(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/DRIFTS_readR.R"))
source(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/model handlR.R"))
source(paste0(root_dir,"/GitHub/paper1/paper1/r/pre_process_eval.R"))



{
  tmp1=read_rds(paste0(root_dir,"/GitHub/BDF/BDF-SSL/4_datasets/Adam-2023_BDF_main_sub-1"))
  tmp2=read_rds(paste0(root_dir,"/GitHub/BDF/BDF-SSL/4_datasets/Adam-2023_BDF_main_sub-2"))
  BDF_main=rbind(tmp1,tmp2)
  rm(tmp1)
  rm(tmp2)
}


```


This notebook contains the processing and evaluation pipeline for the soil physical data, soliTOC analysis and spectral data obtained for the BDF_frisch dataset (containing approx. 460 samples taken from 4 BDF sites in autumn 2023)



# Data loading, processing, and merging to BDF_frisch
This only has to be run if the final dataset is not yet existing or changed / additional data has to be loaded. All data that is loaded here is available from the BDF_frisch dataset loaded below.



## Creating spectral dataset

```{r}

if(F){ # this takes a while to run, much faster to reload final object
  if(F){ # only run when prepared dataset is not available and needs to be created from scratch
  BDF_frisch_spc=OPUSraw_to_Preprocessed(
    folder=paste0(root_dir,"/GitHub/BDF/BDF-SSL/1_data/1_raw_scans/3_scans_frisch"), # opus files save location
    save_raw = T,
    save=T,
    save_location = paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp"),
    return=T,
    id_string_location=c(5,8),
    from=400,
    to=7500,
    reload=F,
    make_upper=T
  )
  }
  
BDF_frisch_spc=read_rds(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/spc_data"))
#check git.ignore for raw_spc and spc_data


# splitting dataset to be able to upload to GitHub (otherwise 100MB limit is busted) 
saveRDS(BDF_frisch_spc[c(1:200),],paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/spc_data_sub-1"))
saveRDS(BDF_frisch_spc[c(201:400),],paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/spc_data_sub-2"))
saveRDS(BDF_frisch_spc[c(401:nrow(BDF_frisch_spc)),],paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/spc_data_sub-3"))
}

#reload 
if(F){
  tmp1=read_rds(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/spc_data_sub-1"))
  tmp2=read_rds(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/spc_data_sub-2"))
  tmp3=read_rds(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/spc_data_sub-3"))
  
  
  BDF_frisch_spc=rbind(
    tmp1,
    tmp2,
    tmp3
  )
  rm(tmp1)
  rm(tmp2)
  rm(tmp3)
}




```

## Loading soliTOC reference data
```{r}
if(F){
BDF_frisch_soliTOC=pull_set_soliTOC(soliTOC_file=list.files(paste0(root_dir,"/GitHub/BDF/BDF-SSL/1_data/2_soliTOC/"),
                                                             pattern = "frisch",
                                                             full.names = T), 
                fix_cols=T,
                ID_col_set="Name",
                set_id=c("LQ","LR","LP","LG"),
                set_memo=c("GT300"),
                Memo_col_set = "Memo",
                ID_col_std="Name",
                std_id="caco3",
                std_value_col="TC  [%]",
                actual=12,
                keep_batch=F,
                omit_check_cols=F)

BDF_frisch_soliTOC=soliTOC_remove_duplicates(
  BDF_frisch_soliTOC,
  measurement_method="DIN19539",
  reference=F,
  method="latest",
  # defaulting german col names
  measurement_method.col_name="Methode",
  date.col_name="Datum",
  time.col_name="Zeit",
  name.col_name="Name",
  reference.col_name="CORG",
  measured.col_name="TOC"
  )

saveRDS(BDF_frisch_soliTOC,paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_frisch_soliTOC"))

BDF_frisch_soliTOC=read_rds(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_frisch_soliTOC"))
}
```



## Calculating TRD data
```{r}
if(F)
# lutro atro merge prio with main frisch ####
{
  BDF_frisch_SAMPLE_LIST<-read_excel(paste0(root_dir,"/GitHub/BDF/BDF-SSL/1_data/Adam-2024-Frischproben_meta.xlsx"),
                                     sheet = "Proben")
  BDF_frisch_SAMPLE_LIST=BDF_frisch_SAMPLE_LIST%>%mutate(`Tiefe von`=as.character(`Tiefe von`),`Tiefe bis`=as.character(`Tiefe bis`))
  BDF_frisch_SAMPLE_LIST=bind_rows(filter(BDF_frisch_SAMPLE_LIST,Proben_ID!="LRCH"),
                                   filter(BDF_frisch_SAMPLE_LIST,Proben_ID=="LRCH")%>%
                                     summarise(across(where(is.double),~sum(.x,na.rm = T)),
                                               across(where(is.character),~first(.x)))
                                   )
  BDF_frisch_SAMPLE_LIST=BDF_frisch_SAMPLE_LIST%>%mutate(`Tiefe von`=as.numeric(`Tiefe von`),`Tiefe bis`=as.numeric(`Tiefe bis`))
saveRDS(BDF_frisch_SAMPLE_LIST,paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/sample_list"))
  }


# DO NOT RUN. Local code kept for transparency. Merging of different excel sheets / stages of processing to create the lutro/atro master table
if(F){
  Probenliste_Atro = read_excel(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/Probenliste_Atro_final.xlsx"),
                                            sheet = "Atro Einwaage",
                                            na="NA",
                                            col_types = c("text",
                                                            "text", "text", "text", "numeric",
                                                            "numeric", "numeric", "numeric",
                                                            "numeric", "numeric", "numeric",
                                                            "numeric", "numeric", "numeric",
                                                            "numeric", "numeric", "numeric",
                                                            "numeric", "numeric", "numeric",
                                                            "numeric", "numeric", "numeric",
                                                            "numeric", "numeric", "numeric",
                                                            "numeric", "text", "text", "text",
                                                            "text", "numeric", "numeric", "numeric",
                                                            "numeric", "numeric", "numeric",
                                                            "numeric", "numeric"))%>%
  select(all_of(
    c(
      "Proben_ID",
      "Typ",
      "BDF",
      "Position",
      "Tiefe von",
      "Tiefe bis",
      "Dose",
      "Gefäß No",
      "Tara",
      "Tara+Lutro",
      "Lutro",
      "Tara+Atro",
      "Atro",
      "Delta",
      "Gesamt (rechnerisch)",
      "notes"
    )))%>%
filter(!notes=="prio-set"|is.na(notes))

Probenliste_Trocknung = read_excel(paste0(root_dir,"/GitHub/R_main/data/soil_physics/raw/Probenliste_Trocknung_final.xlsx"),
                                                      sheet = "Proben Trocknung",
                                                      na="NA")%>%
  select(all_of(
    c(
      "Proben_ID",
      "Typ",
      "BDF",
      "Position",
      "Tiefe von",
      "Tiefe bis",
      "Dose",
      "Tara_plus_Feldfeucht",
      "LUTRO+Dose+Label neu",
      "LUTRO ABSOLUT",
      "Feinboden+Tara",
      "Feinboden Tara",
      "Feinboden",
      "Skelett+Tara",
      "Skelett Tara",
      "Skelett",
      "Verlust(theoretisch max)",
      "Feinboden+Dose+Label",
      "Verlust real",
      "notes"
    )))%>%
filter(!notes=="prio-set"|is.na(notes))




Probenliste_Atro_main_22_02_24=left_join(
  Probenliste_Trocknung,
  Probenliste_Atro,
  by=c(
    "Proben_ID",
    "Typ",
    "BDF",
    "Position",
    "Tiefe von",
    "Tiefe bis",
    "Dose"
  )
)






priority_subset_atro = read_excel(paste0(root_dir,"/GitHub/R_main/data/soil_physics/raw/priority_subset_atro.xlsx"),
                                  na = "NA")
priority_subset_atro = priority_subset_atro%>%select(-...36)


all_BDFfrisch<-bind_rows(
  Probenliste_Atro_main_22_02_24,
rename(priority_subset_atro,gemahlen=GT300,
       `LUTRO+Dose+Label neu`=`LUTRO+Dose+Label`,
       `Gesamt (rechnerisch)`=`Atro gesamt (rechnerisch)`
       )%>%mutate(Progress=if_else(is.na(Atro),0,2),
                      BDF=str_pad(BDF,width=2,side = "left",pad ="0"),
                  )%>%
  select(all_of(
    c(
      "Proben_ID",
      "Typ",
      "BDF",
      "Position",
      "Tiefe von",
      "Tiefe bis",
      "Dose",
      "Tara_plus_Feldfeucht",
      "LUTRO+Dose+Label neu",
      "LUTRO ABSOLUT",
      "Feinboden+Tara",
      "Feinboden Tara",
      "Feinboden",
      "Skelett+Tara",
      "Skelett Tara",
      "Skelett",
      "Verlust(theoretisch max)",
      "Feinboden+Dose+Label",
      "Verlust real",
      "Gefäß No",
      "Tara",
      "Tara+Lutro",
      "Lutro",
      "Tara+Atro",
      "Atro",
      "Delta",
      "Gesamt (rechnerisch)"
    ))))%>%select(-all_of(c("notes.x","notes.y")))

all_BDFfrisch=all_BDFfrisch%>%
  mutate(flags=
           if_else(
             Proben_ID%in%(filter(all_BDFfrisch,`Verlust real`>0|`Verlust real`< -3|`Verlust(theoretisch max)`>0|`Verlust(theoretisch max)`< -3)[["Proben_ID"]]),
             case_match(
               Proben_ID,
               "LPCD"~"supected unreliable Skelett",
               "LQAC"~"NO DATA",
               "LQBC"~"NO DATA",
               "LQCD"~"NO DATA",
               "LQCJ"~"NO DATA",
               "LQEZ"~"slightly pos theoretical loss, maybe Tara or poorly cleaned sieve or wrong sieve tara",
               "LRBB"~"slightly pos theoretical loss, maybe Tara or poorly cleaned sieve",
               "LRBU"~"slightly pos theoretical loss, maybe Tara",
               "LRGM"~"supected unreliable Skelett",
               "LRGT"~"supected unreliable Skelett",
               "LRER"~"realistic, but rel. high loss"
             ),
             NA
           ))


all_BDFfrisch<-
rename(all_BDFfrisch,
  sample_id=Proben_ID,
  Typ=Typ,
  BDF=BDF,
  Position=Position,
  Tiefe_von=`Tiefe von`,
  Tiefe_bis=`Tiefe bis`,
  Dose=Dose,
  Feucht_Dose_Label=Tara_plus_Feldfeucht,
  Lutro_Dose_Label=`LUTRO+Dose+Label neu`,
  LUTRO=`LUTRO ABSOLUT`,
  FB_plusTara=`Feinboden+Tara`,
  Tara_FB=`Feinboden Tara`,
  FB_LUTRO=Feinboden,
  Skelett_plusTara=`Skelett+Tara`,
  Tara_Skelett=`Skelett Tara`,
  Skelett=Skelett,
  loss_th=`Verlust(theoretisch max)`,
  FB_Dose_Label=`Feinboden+Dose+Label`,
  loss=`Verlust real`,
  cup_no=`Gefäß No`,
  cup_Tara=Tara,
  cup_and_lutro=`Tara+Lutro`,
  lutro=Lutro,
  cup_and_atro=`Tara+Atro`,
  atro=Atro,
  delta=Delta,
  ATRO=`Gesamt (rechnerisch)`,
  flags=flags
)%>%
  mutate(
    FB_ATRO=FB_LUTRO-(FB_LUTRO/lutro)*(lutro-atro)+loss,
    ATRO=FB_ATRO+Skelett,
    BDF=if_else(sample_id=="LQCH","30",BDF)) # LQCH is  BDF30, not BDF35... fixing here for further analysis




saveRDS(all_BDFfrisch,paste0(root_dir,"/GitHub/R_main/data/soil_physics/BDF_frisch-lutro_atro"))
write_excel_csv(all_BDFfrisch,paste0(root_dir,"/GitHub/R_main/data/soil_physics/BDF_frisch-lutro_atro.csv"))
}
##### END OF NO-RUN ##
# The output BDF_frisch-lutro_atro has been stored in /1_data/3_physik/ as Adam-2024_BDF_frisch-lutro_atro.csv in this repository

# theroretically output from above should be loaded (BDF_frisch-lutro_atro). But table is identical to Adam-2024_atro_full
# minus the appended densities calculated below. Adding BDF_frisch_lutro_atro to the datasets in the repository would be redundant.
all_BDFfrisch=read_excel(paste0(root_dir,"/GitHub/BDF/BDF-SSL/1_data/3_physik/Adam-2024_atro_full.xlsx"), 
    col_types = c("text", "text", "numeric", 
        "text", 
        rep("numeric",23),
        "text",rep("numeric",6)))

# avg tara weight of sample containers
Dose_125_wt<-18.02 #+-0.3
Dose_250_wt<-24.33 #+-0,09
Dose_375_wt<-25.97 #+-0,075
# avg. label weigth
avg_wt_label<-.35  #-0.1 to +0.3
# sampling device dimensions for volume calculation
RK_diameter<-6.35 # ~2.5 inch (V = pi * RK_diameter^2 / 4 * (Tiefe_bis - Tiefe_von))
QS_vol<-66 # known syringe volume
PS_area<-8*2 # (width*depth, V = PS_area * (Tiefe_bis - Tiefe_von))


filter(all_BDFfrisch,sample_id =="LRCH")%>%
  group_by(sample_id,Typ,BDF,Position,Tiefe_von,Tiefe_bis)%>%
  summarise(across(where(is.numeric),~sum(.x,na.rm = T)),
            across(where(is.character),~first(.x,na_rm = T)) # does not sum Tiefe, which is want i watnted, but unsure why,
            )->lrch_two_jars_to_one_Atro_full                 # maybe detects x=y and treats it as character?

filter(all_BDFfrisch,!sample_id=="LRCH")%>%
  bind_rows(lrch_two_jars_to_one_Atro_full)->Atro_full



Atro_full%>%filter(Tiefe_von>=0&
                     FB_LUTRO>=0)%>%

mutate(
       Lutro_density_FB=case_when(
         substr(sample_id,2,2)=="Q"~FB_LUTRO/QS_vol,
         substr(sample_id,2,2)=="R"~FB_LUTRO/(pi*(RK_diameter/2)^2*abs(Tiefe_von-Tiefe_bis)),
         substr(sample_id,2,2)=="P"~FB_LUTRO/(PS_area*abs(Tiefe_von-Tiefe_bis))
       ),
       Lutro_density_FB_corr=case_when(   
         substr(sample_id,2,2)=="Q"~FB_LUTRO/(QS_vol-Skelett/2.65),
         substr(sample_id,2,2)=="R"~FB_LUTRO/((pi*(RK_diameter/2)^2*abs(Tiefe_von-Tiefe_bis))-Skelett/2.65),
         substr(sample_id,2,2)=="P"~FB_LUTRO/((PS_area*abs(Tiefe_von-Tiefe_bis))-Skelett/2.65)
       ),
       Lutro_density_all=case_when(
         substr(sample_id,2,2)=="Q"~LUTRO/QS_vol,
         substr(sample_id,2,2)=="R"~LUTRO/(pi*(RK_diameter/2)^2*abs(Tiefe_von-Tiefe_bis)),
         substr(sample_id,2,2)=="P"~LUTRO/(PS_area*abs(Tiefe_von-Tiefe_bis))
       ),
       Atro_density_FB=case_when(
         substr(sample_id,2,2)=="Q"~FB_ATRO/QS_vol,
         substr(sample_id,2,2)=="R"~FB_ATRO/(pi*(RK_diameter/2)^2*abs(Tiefe_von-Tiefe_bis)),
         substr(sample_id,2,2)=="P"~FB_ATRO/(PS_area*abs(Tiefe_von-Tiefe_bis))
       ),
       Atro_density_all=case_when(
         substr(sample_id,2,2)=="Q"~ATRO/QS_vol,
         substr(sample_id,2,2)=="R"~ATRO/(pi*(RK_diameter/2)^2*abs(Tiefe_von-Tiefe_bis)),
         substr(sample_id,2,2)=="P"~ATRO/(PS_area*abs(Tiefe_von-Tiefe_bis))
       )
)->Atro_full

Atro_full%>%group_by(Typ,BDF,Position,Tiefe_von)%>%mutate(rep=row_number())%>%
  mutate(Position=if_else(Typ=="Quicksampler",
                                  paste(Position,rep,sep="_"),
                                  Position))->Atro_full

Atro_full=mutate(Atro_full,BDF=str_pad(as.character(BDF),width = 2,side = "left",pad = "0"))

saveRDS(Atro_full,paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/atro_full"))
write_excel_csv(Atro_full,paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/atro_full.csv"))
# !!!!!!!!!!!!!!!!!!!!!!!
# move final changed file manually to /1_data/physics. Barrier to /1_data_physics to have a backup

# !!!load saved version from /1_data/physics!!!
BDF_frisch_TRD=read_rds(paste0(root_dir,"/GitHub/BDF/BDF-SSL/1_data/3_physik/Adam-2024_atro_full"))

# dataset created using ~/GitHub/R_main/R_main/BDF_frisch_lutro_atro.R
# no density values for LG... and straw layer samples ("Krume"), as no volume is defined 

#     saveRDS(Atro_full$model_name,paste0(root_dir,"/GitHub/R_main/data/datasets/BDF_frisch/atro_full"))
#     )
```


## Loading texture data
```{r}
if(F){
BDF_frisch_texture <- read_excel("~/GitHub/BDF/BDF-SSL/1_data/3_physik/Adam-2024-Körnung.xlsx")
}
```



## Merging datasets
```{r}
if(F){
  BDF_frisch=BDF_frisch_spc
  
  
  BDF_frisch_SAMPLE_LIST=
readRDS(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/sample_list"))
  sampling_merge=tibble(sample_id=BDF_frisch_SAMPLE_LIST$Proben_ID,
                      sampling_data=BDF_frisch_SAMPLE_LIST%>%rename(sample_id=Proben_ID,Tiefe_von=`Tiefe von`,Tiefe_bis=`Tiefe bis`))
  BDF_frisch=left_join(BDF_frisch,sampling_merge,by="sample_id")
  rm(sampling_merge)
  
  soliTOC_merge=tibble(sample_id=BDF_frisch_soliTOC$Name,soliTOC=BDF_frisch_soliTOC)
  BDF_frisch=left_join(BDF_frisch,soliTOC_merge,by="sample_id")
  rm(soliTOC_merge)
  
  TRD_merge=tibble(sample_id=BDF_frisch_TRD$sample_id,TRD=BDF_frisch_TRD)
  BDF_frisch=left_join(BDF_frisch,TRD_merge,by="sample_id")
  rm(TRD_merge)
  
  texture_merge=tibble(sample_id=BDF_frisch_texture$`Proben-Nr.`,texture=BDF_frisch_texture)
  BDF_frisch=left_join(BDF_frisch,texture_merge,by="sample_id")
  rm(texture_merge)
  
  
  # splitting dataset to be able to upload to GitHub (otherwise 100MB limit is busted) 
  saveRDS(BDF_frisch[c(1:200),],paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_frisch_sub-1"))
  saveRDS(BDF_frisch[c(201:400),],paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_frisch_sub-2"))
  saveRDS(BDF_frisch[c(401:nrow(BDF_frisch)),],paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_frisch_sub-3"))
}
#!!!!
# saved in /3_r_scripts/temp
```

# Load BDF_frisch (final object)
```{r}
# !!!!loads from /4_datasets (chunk above saves to /3_r_scripts/temp)
#reload 
{
  tmp1=read_rds(paste0(root_dir,"/GitHub/BDF/BDF-SSL/4_datasets/Adam-2024_BDF_frisch_sub-1"))
  tmp2=read_rds(paste0(root_dir,"/GitHub/BDF/BDF-SSL/4_datasets/Adam-2024_BDF_frisch_sub-2"))
  tmp3=read_rds(paste0(root_dir,"/GitHub/BDF/BDF-SSL/4_datasets/Adam-2024_BDF_frisch_sub-3"))
  
  
  BDF_frisch=rbind(
    tmp1,
    tmp2,
    tmp3
  )
  rm(tmp1)
  rm(tmp2)
  rm(tmp3)
}



BDF_labeller=labeller(
  BDF=c(`02`="BDF02 (Acker, Elbaue Riesa/Torgau)",
        `23`="BDF23 (Acker, Erzgebirgskamm)",
        `30`="BDF30 (Grünland, Elbaue Dresdner Elbtal)",
        `35`="BDF35 (Acker, Nordöstl. Erzgebirgsrand)")
)
BDF_labeller_manual=c(`02`="BDF02 (Acker, Elbaue Riesa/Torgau)",
        `23`="BDF23 (Acker, Erzgebirgskamm)",
        `30`="BDF30 (Grünland, Elbaue Dresdner Elbtal)",
        `35`="BDF35 (Acker, Nordöstl. Erzgebirgsrand)")
  

```

# Load reference data
```{r}
{
# TRD measuerd traditionally (soil cylinders) by us in the scope of the sampling campaign
Lagerungsdichte_Referenz_neu <- read_excel(paste0(root_dir,"/GitHub/BDF/BDF-SSL/1_data/3_physik/Adam-2024_VZ-TRD.xlsx"))
TRD_neu=left_join(
  Lagerungsdichte_Referenz_neu%>%mutate(Tiefe_avg=(`Tiefe von`+`Tiefe bis`)/2)%>%
  group_by(BDF=`BDF-Fläche`,Horizont,`Tiefe von`,`Tiefe bis`,Tiefe_avg)%>%
  summarise(minTRD=min(`TRD g/cm3`),maxTRD=max(`TRD g/cm3`),TRD=mean(`TRD g/cm3`)),

#manually assigning Horizont for merge
filter(BDF_frisch,substr(sample_id,1,2)=="LG"&!is.na(sampling_data$BDF))%>%select(-c("TRD"))%>%
  mutate(BDF=sampling_data$BDF,
         Horizont=case_match(sampling_data$BDF,
                             "02"~case_match(as.character(sampling_data$Tiefe_von),
                                             "6"~"Ap",
                                             "20"~"rAp",
                                             "35"~"aM",
                                             "65"~"II aM"
                                               ),
                             "23"~case_match(as.character(sampling_data$Tiefe_von),
                                             "2"~"Ap",
                                             "38"~"Sw-Bv"),
                             "30"~case_match(as.character(sampling_data$Tiefe_von),
                                             "4"~"aAxh",
                                             "30"~"aAxh_2",
                                             "54"~"Axh-aM"
                                               ),
                             "35"~case_match(as.character(sampling_data$Tiefe_von),
                                             "5"~"Ap",
                                             "20"~"rAp",
                                             "38"~"Sw",
                                             "65"~"Sdw"
                                               )
                            )
  ),
by=c(
  "BDF"="BDF",
  "Horizont"="Horizont"
)
)

}

# BDF reference data from site characterisation sheets
{
Lagerungsdichte_Referenz <- read_excel(paste0(root_dir,"/GitHub/BDF/BDF-SSL/5_Provided_BDF-Database/Adam-2024_Lagerungsdichten_Referenz.xlsx"), na = "NA")
Lagerungsdichte_Referenz$BDF<-str_remove(Lagerungsdichte_Referenz$BDF,"BDF")
}

```



# Loading pF data
```{r}
#Drucktoepfe
BDF_frisch_pF_MASTER <- read_excel(paste0(root_dir,"/GitHub/BDF/BDF-SSL/1_data/3_physik/Adam-2024_BDF_frisch_pF_toepfe.xlsx"),sheet="Drucktoepfe")


#VZ Daten
BDF_frisch_pF_MASTER$ZylinderNo=BDF_frisch_pF_MASTER$ZylinderNo%>%as.character()
Stechzylinder_meta=read_excel(paste0(root_dir,"/GitHub/BDF/BDF-SSL/1_data/3_physik/Adam-2024_VZ-TRD.xlsx"))
Stechzylinder_meta$Stechzylindernummer=Stechzylinder_meta$Stechzylindernummer%>%as.character()
Drucktoepfe=left_join(Stechzylinder_meta,BDF_frisch_pF_MASTER,by=c("Stechzylindernummer"="ZylinderNo"))%>%
  filter(Größe!=250)%>%
  pivot_longer(cols = all_of(c("pF_0","pF_1.8","pF_2.5","pF_3.5","pF_7")))%>%
  mutate(name=str_remove(name,"pF_")%>%as.numeric)%>%rename(pF=name,VWC=value,VZ_No=Stechzylindernummer)%>%filter(pF!=7)
  
  

# Hyprop
{
HYPROP_pF_VWC=c()
HYPROP_VWC_K=c()
HYPROP_K_pF=c()
for(i in list.files(paste0(root_dir,"/GitHub/BDF/BDF-SSL/1_data/3_physik/1_Hyprop_raw/"),full.names = T)){
  print(i)
  
  HYPROP_pF_VWC=bind_rows(HYPROP_pF_VWC,
  tibble(VZ_id=  str_remove(basename(i),".xlsx"),                        
  full_join(
    read_excel(i, sheet = "Evaluation-Retention Θ(pF)"),
    read_excel(i, sheet = "Fitting-Retention Θ(pF)"),
    suffix = c(".eval",".fit"),by="pF [-]")))
  
  
  HYPROP_VWC_K=bind_rows(HYPROP_VWC_K,
  tibble(VZ_id=  str_remove(basename(i),".xlsx"),   
 full_join(read_excel(i, sheet = "Evaluation-Conductivity K(Θ)"),
           read_excel(i, sheet = "Fitting-Conductivity K(Θ)"),
  suffix = c(".eval",".fit"),by="Water Content [Vol%]")))
  

    HYPROP_K_pF=bind_rows(HYPROP_K_pF,
  tibble(VZ_id=  str_remove(basename(i),".xlsx"),
  full_join(read_excel(i, sheet = "Evaluation-Conductivity K(pF)"),
  read_excel(i, sheet = "Fitting-Conductivity K(pF)"),
  suffix = c(".eval",".fit"),by=  "log 10 K [cm/d]" )))
 
}

# JOIN
HYPROP_pF_VWC=left_join(HYPROP_pF_VWC,Stechzylinder_meta,by=c("VZ_id"="Stechzylindernummer"))
HYPROP_K_pF=left_join(HYPROP_K_pF,Stechzylinder_meta,by=c("VZ_id"="Stechzylindernummer"))
HYPROP_VWC_K=left_join(HYPROP_VWC_K,Stechzylinder_meta,by=c("VZ_id"="Stechzylindernummer"))

# making BDF30 two aAxh unique
HYPROP_pF_VWC=HYPROP_pF_VWC%>%mutate(Horizont=if_else(Horizont=="aAxh","aAxh (1)",if_else(Horizont=="aAxh_2","aAxh (2)",Horizont)))
HYPROP_K_pF=HYPROP_K_pF%>%mutate(Horizont=if_else(Horizont=="aAxh","aAxh (1)",if_else(Horizont=="aAxh_2","aAxh (2)",Horizont)))
HYPROP_VWC_K=HYPROP_VWC_K%>%mutate(Horizont=if_else(Horizont=="aAxh","aAxh (1)",if_else(Horizont=="aAxh_2","aAxh (2)",Horizont)))

  }

```


# plotting pF
```{r}

svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_frisch_pF_plot.svg"),width = 10,height = 5)

ggarrange(

  
(HYPROP_pF_VWC%>%
  ggplot(aes(col=`BDF-Fläche`,
             linetype=as.character(Horizont),
             shape=as.character(Horizont),
             x=`pF [-]`,
             y=`Water Content [Vol%].fit`,
             #group=paste(`BDF-Fläche`,`Tiefe von`)
                  ))+geom_line(linewidth=.75)+
  geom_point(aes(y=
               `Water Content [Vol%].eval`),size=1.5,alpha=.5)+
#  geom_point(data=Drucktoepfe,aes(x=pF,y=VWC))+
  theme_pubr()+
  xlim(c(-.5,6))+
  xlab("pF")+
  ylab("VWC [%]")+
  scale_color_manual("BDF",breaks=c("02","23","30","35"),values=colorblind_safe_colors[c(2,3,4,7)])+
  scale_shape_manual("Horizont",breaks=c("Ap","aAxh (1)",
                                    "rAp","aAxh (2)","Sw-Bv",
                                    "Sw","aM","Axh-aM",
                                    "Sdw","II aM"),
                     values=c(0,0,
                              1,1,1,
                              2,2,2,
                              6,6))+
  scale_linetype_manual("Horizont",,breaks=c("Ap","aAxh (1)",
                                    "rAp","aAxh (2)","Sw-Bv",
                                    "Sw","aM","Axh-aM",
                                    "Sdw","II aM"),
                        values=c("solid","solid",
                                 "longdash","longdash","longdash",
                                 "dotdash","dotdash","dotdash",
                                 "dotted","dotted"))
),
(
HYPROP_K_pF%>%
  ggplot(aes(col=`BDF-Fläche`,
             linetype=as.character(Horizont),
             shape=as.character(Horizont),x=`pF [-].fit`,y=`log 10 K [cm/d]`
             
                  ))+geom_line(linewidth=.75)+
  geom_point(aes(x=
               `pF [-].eval`),size=1.5,alpha=.5)+
  theme_pubr()+
  xlim(c(-.5,4))+
  ylim(c(-6,2))+
    xlab("pF")+
  ylab(expression("log(K cm "*d^-1*")"))+
  scale_color_manual("BDF",breaks=c("02","23","30","35"),values=colorblind_safe_colors[c(2,3,4,7)])+
  scale_shape_manual("Horizont",breaks=c("Ap","aAxh (1)",
                                    "rAp","aAxh (2)","Sw-Bv",
                                    "Sw","aM","Axh-aM",
                                    "Sdw","II aM"),
                     values=c(0,0,
                              1,1,1,
                              2,2,2,
                              6,6))+
  scale_linetype_manual("Horizont",breaks=c("Ap","aAxh (1)",
                                    "rAp","aAxh (2)","Sw-Bv",
                                    "Sw","aM","Axh-aM",
                                    "Sdw","II aM"),
                        values=c("solid","solid",
                                 "longdash","longdash","longdash",
                                 "dotdash","dotdash","dotdash",
                                 "dotted","dotted"))

),
common.legend = T
)
dev.off()


```


# texture
```{r}

# Load the Data. (Available in ggtern 1.0.3.0 next version)


Lagerungsdichte_Referenz%>%mutate(Horizont=if_else(Horizont=="II Sdw","Sdw",Horizont))%>%
  select(S,U,`T`,Horizont,BDF)%>%
  right_join(
    (BDF_frisch$texture%>%na.omit%>%
       select(`Proben-Nr.`,S,U,`T`)%>%
       left_join(
         Lagerungsdichte_Referenz_neu%>%
           select(LG_sample,`BDF-Fläche`,Horizont),
         by=c("Proben-Nr."="LG_sample"))
     ),
    by=c("BDF"="BDF-Fläche","Horizont"),
    suffix = c(".BDF",".Frisch"))%>%
  group_by(BDF,Horizont)%>%
  summarise_all(first)%>%
  mutate(S.diff=S.Frisch-S.BDF,U.diff=U.Frisch-U.BDF,T.diff=T.Frisch-T.BDF)%>%
  write_excel_csv(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_frisch_texture.csv"))
# BDF texture ####
 svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_frisch_texture.svg"),width = 7,height = 7)
  TT.plot(
          class.sys =  "DE.BK94.TT",
        tri.data=TT.normalise.sum(data.frame(BDF_frisch$texture%>%na.omit%>%rename(SAND=S,SILT=U,CLAY=`T`))),
        col=mutate(BDF_frisch$sampling_data,z=case_match(BDF,                                                                                            "02"~colorblind_safe_colors[2],                                                                                    "23"~colorblind_safe_colors[4],                                                                                    "30"~colorblind_safe_colors[6],                                                                                    "35"~colorblind_safe_colors[8])                                                                                                               )%>%pull(z),pch=16)#,col=colorblind_safe_colors[c(2:4)])
dev.off()
```

# dummyplot for legend
 svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_frisch_texture_legend.svg"),width = 7,height = 7)
ggplot(data.frame(BDF=unique(BDF_frisch$sampling_data$BDF)))+
         geom_point(aes(x=1,y=1,col=BDF))+
  scale_color_manual(breaks=c("02","23","30","35"),values = colorblind_safe_colors[c(2,4,6,8)])
dev.off()

#,col=BDF_frisch$sampling_data$BDF,pch=16)
# ####

#'BDF02
#' Sl3
#'
#'BDF23
#' Sl4
#'
#'BDF30
#'aAxh(1) 
#' Uls
#'Rest
#' Ls2
#' 
#'BDF35
#'Ap/rAp
#' Ut3
#'Rest 
#' Ut4  
#'





# Density comparison
```{r}
# interactive ####
ggplotly(
  BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q","P")&Tiefe_von>=0) %>%
    ggplot(
      aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=Atro_density_all,linetype=Typ,alpha=Typ,col=BDF))+
    #manual gridlines
    geom_hline(yintercept = seq(.6,2.8,.1),col="grey15",linewidth=.025)+
    geom_vline(xintercept = seq(0,150,10),col="grey15",linewidth=.025)+
    geom_vline(xintercept = 0,linewidth=.2,col="black")+


    geom_line(aes(group=paste(BDF,Position,Typ),col=BDF),linewidth=.1)+
    geom_smooth(se=F,linewidth=1)+
    geom_line(data = filter(Lagerungsdichte_Referenz,Tiefe<100),
              aes(x=Tiefe,
                  y=TRD,
                  col=BDF,
                  linetype="BDF-Referenz",
                  alpha="BDF-Referenz"),
              linewidth=1,
             )+
    geom_errorbar(data = TRD_neu,
    aes(
      x=Tiefe_avg,
      y=`TRD`,
      col=BDF,
      ymin=minTRD,
      ymax=maxTRD,
      width=.1,#`Tiefe bis`-`Tiefe von`,
      linetype="neu",
      alpha="neu"
    ),
    linewidth=1
    )+
        coord_flip(xlim=c(150,0))+
    scale_x_reverse("Tiefe [cm]",
                    breaks=seq(0,150,50),
                    minor_breaks=seq(0,150,10),
                   )+
    #scale_color_manual(breaks=c("02","23","30","35"),values=colorblind_safe_colors[c(2:4,8)],labels=paste("BDF",c("02","23","30","35")))+
    scale_linetype_manual("",breaks=c("neu","BDF-Referenz","Profilspaten","Quicksampler","Rammkern"),values=c("solid","solid","dotdash","dashed","dotted"),labels=c("Referenz neu","Referenz","PS","QS","RK"))+
    scale_alpha_manual("",breaks=c("neu","BDF-Referenz","Profilspaten","Quicksampler","Rammkern"),values=c(.5,1,1,1,1),labels=c("Referenz neu","Referenz","PS","QS","RK"))+
    scale_color_manual("",breaks=c("02","23","30","35"),values = colorblind_safe_colors[c(2:4,8)],labels=c("BDF02","BDF23","BDF30","BDF35"))+
    ylab("TRD [g/cm³]")+
    theme_pubr()+
    theme(legend.box="vertical",
          #legend.position = "top"
          #panel.grid = element_line(colour = "grey"),
          #panel.grid.major = element_line(colour = "grey",linewidth = 1),
          #panel.grid.minor = element_line(colour = "grey",linewidth = 1,linetype = "solid")
          )+
  facet_wrap(facets = vars(BDF),labeller = BDF_labeller,scales = "free",nrow = 1)#function(x){paste("BDF",x)})
)%>%layout(legend=list(x=0,
                       y=-.20,
                       xanchor='left',
                       yanchor='bottom',
                       orientation='h'))


# for report ####
{
svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_TRD_frisch_full.svg"),width = 8,height = 8)
      plot(ggplot(
      )+
    #manual gridlines
 #   geom_hline(yintercept = seq(.6,2.8,.1),col="grey15",linewidth=.025)+
  #  geom_vline(xintercept = seq(0,150,10),col="grey15",linewidth=.025)+
   # geom_vline(xintercept = 0,linewidth=.2,col="black")+
# BDF Ref  
    geom_line(data = filter(Lagerungsdichte_Referenz),
              aes(x=Tiefe,
                  y=TRD,
                  col="BDF-Referenz",
                  linetype="BDF-Referenz",
                  alpha="BDF-Referenz"),
              linewidth=1,
             )+
# Ref neu
    geom_errorbar(data = TRD_neu,
    aes(
      x=Tiefe_avg,
      y=TRD,
      col="neu",
      ymin=minTRD,
      ymax=maxTRD,
      width=`Tiefe bis`-`Tiefe von`,
      linetype="neu",
      alpha="neu"
    ),
    linewidth=1
    )+
  
# RK PS QS
    geom_line(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q","P")&Tiefe_von>=0)), 
      aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=Atro_density_all,
        linetype=Typ,
        alpha=Typ,
        col=Typ,
        group=paste(BDF,Position,Typ)),
              linewidth=.25)+
    geom_smooth(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q","P")&Tiefe_von>=0)),
                aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=Atro_density_all,
        linetype=Typ,
        alpha=Typ,
        col=Typ,
        group=paste(BDF,Typ)),
        se=F,linewidth=1,inherit.aes = T)+
  #formatting
    coord_flip(xlim=c(150,0))+
    scale_x_reverse("Tiefe [cm]",
                    breaks=seq(0,150,50),
                    minor_breaks=seq(0,150,10),
                   )+
    #scale_color_manual(breaks=c("02","23","30","35"),values=colorblind_safe_colors[c(2:4,8)],labels=paste("BDF",c("02","23","30","35")))+
    scale_linetype_manual("",
                          breaks=c("neu","BDF-Referenz","Profilspaten","Quicksampler","Rammkern"),
                          values=c("solid","solid","dotdash","dashed","dotted"),
                          labels=c("Referenz Frischprobenahme","Referenz Erstaufnahme","Profilspaten","Quicksampler","Rammkern"))+
    scale_alpha_manual("",
                       breaks=c("neu","BDF-Referenz","Profilspaten","Quicksampler","Rammkern"),
                       values=c(1,1,1,1,1),
                       labels=c("Referenz Frischprobenahme","Referenz Erstaufnahme","Profilspaten","Quicksampler","Rammkern"))+
    scale_color_manual("",
                       breaks=c("neu","BDF-Referenz","Profilspaten","Quicksampler","Rammkern"),
                       values = c(colorblind_safe_colors[c(6,7)],"black","black","black"),
                       labels=c("Referenz Frischprobenahme","Referenz Erstaufnahme","Profilspaten","Quicksampler","Rammkern"))+
    ylab("TRD [g/cm³]")+
  ylim(BDF_frisch$TRD$Atro_density_all%>%range(na.rm = T))+
    theme_pubr()+
    theme(#legend.direction ="vertical",
          legend.position = "none"
          #panel.grid = element_line(colour = "grey"),
          #panel.grid.major = element_line(colour = "grey",linewidth = 1),
          #panel.grid.minor = element_line(colour = "grey",linewidth = 1,linetype = "solid")
          )+
  facet_wrap(facets = vars(BDF),labeller = BDF_labeller,scales = "free",nrow = 2))
dev.off()
}
```
# TOC profiles
```{r}


# for report ####
{
svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_TOC_frisch_full.svg"),width = 8,height = 8)
      plot(
        ggplot(
      )+
    #manual gridlines
 #   geom_hline(yintercept = seq(.6,2.8,.1),col="grey15",linewidth=.025)+
  #  geom_vline(xintercept = seq(0,150,10),col="grey15",linewidth=.025)+
   # geom_vline(xintercept = 0,linewidth=.2,col="black")+
# BDF Ref  
    geom_line(data = filter(Lagerungsdichte_Referenz),
              aes(x=Tiefe,
                  y=CORG, # 10e-2 g/cm³ | 1ha =10e8 cm² , 1 T = 10^6 g -> 1 10^-2g/cm³ = 1 T/ha*cm
                  col="BDF-Referenz",
                  linetype="BDF-Referenz",
                  alpha="BDF-Referenz"),
              linewidth=1,
             )+

  
# RK PS QS
    geom_line(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q","P")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))), 
      aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=TOC,   # same as weighed for TOC determination
        linetype=Typ,
        alpha=Typ,
        col=Typ,
        group=paste(BDF,Position,Typ)),
              linewidth=.25)+
    geom_smooth(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q","P")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))), 
                aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=TOC,
        linetype=Typ,
        alpha=Typ,
        col=Typ,
        group=paste(BDF,Typ)),
        se=F,linewidth=1,inherit.aes = T)+
  
   geom_point(data=(TRD_neu%>%left_join(TRD_neu$soliTOC,by=c("sample_id"="Name"))),
    aes(
      x=Tiefe_avg,
      y=TOC,
      col="neu",
      linetype="neu",
      alpha="neu"
    ),
    size=2,
    shape=4,
    stroke=2)+
  #formatting
       coord_flip(xlim=c(150,0))+
    scale_x_reverse("Tiefe [cm]",
                    breaks=seq(0,150,50),
                    minor_breaks=seq(0,150,10),
                   )+
    #scale_color_manual(breaks=c("02","23","30","35"),values=colorblind_safe_colors[c(2:4,8)],labels=paste("BDF",c("02","23","30","35")))+
    scale_linetype_manual("",
                          breaks=c("neu","BDF-Referenz","Profilspaten","Quicksampler","Rammkern"),
                          values=c("solid","solid","dotdash","dashed","dotted"),
                          labels=c("Referenz neu","Referenz","PS","QS","RK"))+
    scale_alpha_manual("",
                       breaks=c("neu","BDF-Referenz","Profilspaten","Quicksampler","Rammkern"),
                       values=c(1,1,1,1,1),
                       labels=c("Referenz neu","Referenz","PS","QS","RK"))+
    scale_color_manual("",
                       breaks=c("neu","BDF-Referenz","Profilspaten","Quicksampler","Rammkern"),
                       values = c(colorblind_safe_colors[c(6,7)],"black","black","black"),
                       labels=c("Referenz neu","Referenz","PS","QS","RK"))+
    ylab("TOC [M-%]")+
  ylim(c(0,6))+
    theme_pubr()+
    theme(#legend.box="vertical",
          legend.position = "none"
          #panel.grid = element_line(colour = "grey"),
          #panel.grid.major = element_line(colour = "grey",linewidth = 1),
          #panel.grid.minor = element_line(colour = "grey",linewidth = 1,linetype = "solid")
          )+
  facet_wrap(facets = vars(BDF),labeller = BDF_labeller,scales = "free",nrow = 2)
)
dev.off()
}

```



# TOC Budget profiles
```{r}


# for report ####
{
svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_TOC_Bilanz_frisch_full.svg"),width = 8,height = 8)
      plot(ggplot(
      )+
    #manual gridlines
 #   geom_hline(yintercept = seq(.6,2.8,.1),col="grey15",linewidth=.025)+
  #  geom_vline(xintercept = seq(0,150,10),col="grey15",linewidth=.025)+
   # geom_vline(xintercept = 0,linewidth=.2,col="black")+
# BDF Ref  
    geom_line(data = filter(Lagerungsdichte_Referenz),
              aes(x=Tiefe,
                  y=TRD*CORG, # 10e-2 g/cm³ | 1ha =10e8 cm² , 1 T = 10^6 g -> 1 10^-2g/cm³ = 1 T/ha*cm
                  col="BDF-Referenz",
                  linetype="BDF-Referenz",
                  alpha="BDF-Referenz"),
              linewidth=1,
             )+

  
# RK PS QS
    geom_line(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q","P")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))), 
      aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=Lutro_density_FB_corr*TOC,   # same as weighed for TOC determination
        linetype=Typ,
        alpha=Typ,
        col=Typ,
        group=paste(BDF,Position,Typ)),
              linewidth=.25)+
    geom_smooth(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q","P")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))), 
                aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=Lutro_density_FB_corr*TOC, # same as weighed for TOC determination
        linetype=Typ,
        alpha=Typ,
        col=Typ,
        group=paste(BDF,Typ)),
        se=F,linewidth=1,inherit.aes = T)+ geom_errorbar(data=(Lagerungsdichte_Referenz_neu%>%left_join(select(TRD_neu%>%filter(!is.na(BDF)),all_of(c("BDF-Fläche"="BDF","Horizont","soliTOC"))),by=c("BDF-Fläche","Horizont","Tiefe von", "Tiefe bis"))%>%
      mutate(Tiefe_avg=(`Tiefe bis`+`Tiefe von`)/2,
             TOC_budget=soliTOC$TOC*`TRD g/cm3`)%>%
        group_by(BDF=`BDF-Fläche`,Horizont,Tiefe_avg)%>%
        summarise(meanTOCbudget=mean(TOC_budget),
                  maxTOCbudget=max(TOC_budget),
                  minTOCbudget=min(TOC_budget))),
    aes(
      x=Tiefe_avg,
      y=meanTOCbudget,
      ymin=minTOCbudget,
      ymax=maxTOCbudget,
      col="neu",
      linetype="neu",
      alpha="neu"
    ),
    width=5)+
    #size=2,
    #shape=4,
    #stroke=2)+
  #formatting
    coord_flip(xlim=c(150,0))+
    scale_x_reverse("Tiefe [cm]",
                    breaks=seq(0,150,50),
                    minor_breaks=seq(0,150,10),
                   )+
    #scale_color_manual(breaks=c("02","23","30","35"),values=colorblind_safe_colors[c(2:4,8)],labels=paste("BDF",c("02","23","30","35")))+
    scale_linetype_manual("",
                          breaks=c("neu","BDF-Referenz","Profilspaten","Quicksampler","Rammkern"),
                          values=c("solid","solid","dotdash","dashed","dotted"),
                          labels=c("Referenz neu","Referenz","PS","QS","RK"))+
    scale_alpha_manual("",
                       breaks=c("neu","BDF-Referenz","Profilspaten","Quicksampler","Rammkern"),
                       values=c(1,1,1,1,1),
                       labels=c("Referenz neu","Referenz","PS","QS","RK"))+
    scale_color_manual("",
                       breaks=c("neu","BDF-Referenz","Profilspaten","Quicksampler","Rammkern"),
                       values = c(colorblind_safe_colors[c(6,7)],"black","black","black"),
                       labels=c("Referenz neu","Referenz","PS","QS","RK"))+
    ylab(expression("TOC [T "*ha^-1*cm^-1*"]"))+
  ylim(range(BDF_frisch$TRD$Lutro_density_FB_corr*BDF_frisch$soliTOC$TOC,na.rm = T))+
    theme_pubr()+
    theme(legend.box="vertical",
          #legend.position = "top"
          #panel.grid = element_line(colour = "grey"),
          #panel.grid.major = element_line(colour = "grey",linewidth = 1),
          #panel.grid.minor = element_line(colour = "grey",linewidth = 1,linetype = "solid")
          )+
  facet_wrap(facets = vars(BDF),labeller = BDF_labeller,scales = "free",nrow = 2))
dev.off()
}


```




```{r}
  
mutate(Lagerungsdichte_Referenz,TOC_budget=TRD*CORG)%>%filter()


# barplots individual cores####
{
svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/TOC_budget_full.svg"),width = 8,height = 4)
  plot(
(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name")))%>%
  mutate(
    TOC_budget_lutroFB=
       TOC/100 #gC/g
     *Lutro_density_FB_corr# gC/cm3 ############# !using corr
     *1000#kg/m³
     *10#t/ha*m
     *(abs(Tiefe_von-Tiefe_bis)/100),
     
   TOC_budget_lutroAll=TOC/100 #gC/g
     *Lutro_density_all# gC/cm3
     *1000#kg/m³
     *10#t/ha*m
     *(abs(Tiefe_von-Tiefe_bis)/100),
     
   TOC_budget_atroFB=
       TOC/100 #gC/g
     *Atro_density_FB# gC/cm3
     *1000#kg/m³
     *10#t/ha*m
     *(abs(Tiefe_von-Tiefe_bis)/100),
     
   TOC_budget_atroAll=TOC/100 #gC/g
     *Atro_density_all# gC/cm3
     *1000#kg/m³
     *10#t/ha*m
     *(abs(Tiefe_von-Tiefe_bis)/100)
   )%>%
  filter(Tiefe_bis<=30)%>%
  group_by(BDF,Typ,Tiefe_von,Tiefe_bis,Position)%>%
  summarise(across(contains("TOC_budget"),.fns=mean))%>%#(TOC_budget,na.rm = T))%>%
  group_by(BDF,Typ,Position)%>%
  summarise(TOC_sum_lutroFB=sum(TOC_budget_lutroFB),
            TOC_sum_lutroAll=sum(TOC_budget_lutroAll),
            TOC_sum_atroFB=sum(TOC_budget_atroFB),
            TOC_sum_atroAll=sum(TOC_budget_atroAll))%>%
  # reference data 
  rbind(
    data.frame(
    BDF=c("02","23","30","35","23"),
    Typ=c(rep("Referenz",4),"Quicksampler"),
    Position=rep(NA,5),
    # sums for top 30 cm
    TOC_sum_lutroFB=c(57.4,86.2,127.6,46.4,NA),  #all the same, but for easier ggplot flow
    TOC_sum_lutroAll=c(57.4,86.2,127.6,46.4,NA),
    TOC_sum_atroFB=c(57.4,86.2,127.6,46.4,NA),
    TOC_sum_atroAll=c(57.4,86.2,127.6,46.4,NA))
  )%>%
  ggplot(aes(x=paste(BDF),group=paste(Typ,Position),y=TOC_sum_lutroFB))+geom_col(position = "dodge",col="black",aes(fill=Typ))+
  geom_text(angle=90,aes(x=BDF,group=paste(Typ,Position),y=10,label=Position,hjust = 0,vjust=.5),
            position=position_dodge(width=.925),size = unit(3,"pt"))+
  theme_pubr()+
  scale_fill_manual(breaks=c("Quicksampler","Rammkern","Referenz"),values=colorblind_safe_colors[2:4])+
  ylab(expression("TOC [T C "*ha^-1 *cm^-1*"]"))+
  xlab("BDF")
  )    
  dev.off()
}


```

```{r}
# barplots individual cores 50cm####
{
svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/TOC_budget_full.svg"),width = 8,height = 4)
  plot(
(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name")))%>%
  mutate(
    TOC_budget_lutroFB=
       TOC/100 #gC/g
     *Lutro_density_FB_corr# gC/cm3
     *1000#kg/m³
     *10#t/ha*m
     *(abs(Tiefe_von-Tiefe_bis)/100),
     
   TOC_budget_lutroAll=TOC/100 #gC/g
     *Lutro_density_all# gC/cm3
     *1000#kg/m³
     *10#t/ha*m
     *(abs(Tiefe_von-Tiefe_bis)/100),
     
   TOC_budget_atroFB=
       TOC/100 #gC/g
     *Atro_density_FB# gC/cm3
     *1000#kg/m³
     *10#t/ha*m
     *(abs(Tiefe_von-Tiefe_bis)/100),
     
   TOC_budget_atroAll=TOC/100 #gC/g
     *Atro_density_all# gC/cm3
     *1000#kg/m³
     *10#t/ha*m
     *(abs(Tiefe_von-Tiefe_bis)/100)
   )%>%
  filter(Tiefe_bis<=50)%>%
  group_by(BDF,Typ,Tiefe_von,Tiefe_bis,Position)%>%
  summarise(across(contains("TOC_budget"),.fns=mean))%>%#(TOC_budget,na.rm = T))%>%
  group_by(BDF,Typ,Position)%>%
  summarise(TOC_sum_lutroFB=sum(TOC_budget_lutroFB),
            TOC_sum_lutroAll=sum(TOC_budget_lutroAll),
            TOC_sum_atroFB=sum(TOC_budget_atroFB),
            TOC_sum_atroAll=sum(TOC_budget_atroAll))%>%
  # reference data 
  rbind(
    data.frame(
    BDF=c("02","23","30","35","23"),
    Typ=c(rep("Referenz",4),"Quicksampler"),
    Position=rep(NA,5),
    # sums for top 30 cm
    TOC_sum_lutroFB=c(75,92.7,206.6,52.3,NA),  #all the same, but for easier ggplot flow
    TOC_sum_lutroAll=c(75,92.7,206.6,52.3,NA),
    TOC_sum_atroFB=c(575,92.7,206.6,52.3,NA),
    TOC_sum_atroAll=c(75,92.7,206.6,52.3,NA))
  )%>%
  ggplot(aes(x=paste(BDF),group=paste(Typ,Position),y=TOC_sum_lutroFB))+geom_col(position = "dodge",col="black",aes(fill=Typ))+
  geom_text(angle=90,aes(x=BDF,group=paste(Typ,Position),y=10,label=Position,hjust = 0,vjust=.5),
            position=position_dodge(width=.925),size = unit(3,"pt"))+
  theme_pubr()+
  scale_fill_manual(breaks=c("Quicksampler","Rammkern","Referenz"),values=colorblind_safe_colors[2:4])+
  ylab(expression("TOC [T C "*ha^-1 *cm^-1*"]"))+
  xlab("BDF")
  )    
  dev.off()
}


```



```{r}
#barplot aggregated with errorbar 30####
{
  maxDepth=30 # check if RK / QS depth is avail for all cores
svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/TOC_budget_full.svg"),width = 10,height = 4)
plot( 
ggarrange(
 (
BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q")&Tiefe_von>=0)%>%
   left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))%>%
  mutate(
   TOC_budget_lutroAll=TOC/100 #gC/g
     *Lutro_density_all# gC/cm3
     *1000#kg/m³
     *10#t/ha*m
     *(abs(Tiefe_von-Tiefe_bis)/100)
   )%>%
  filter(Tiefe_bis<=maxDepth)%>%
  group_by(BDF,Typ,Tiefe_von,Tiefe_bis,Position)%>%
  summarise(across(contains("TOC_budget"),.fns=mean))%>%#(TOC_budget,na.rm = T))%>%
  group_by(BDF,Typ,Position)%>%
  summarise(
            TOC_sum_lutroAll=sum(TOC_budget_lutroAll)
)%>%
  group_by(BDF,Typ)%>%
  summarise(
    TOC_sum_lutroAll_mean=mean(TOC_sum_lutroAll),
    TOC_sum_lutroAll_max=max(TOC_sum_lutroAll),
    TOC_sum_lutroAll_min=min(TOC_sum_lutroAll),
    TOC_sum_lutroAll_n=length(TOC_sum_lutroAll)
  )%>%
  # reference data 
  rbind(data.frame(
    (Lagerungsdichte_Referenz_neu%>%
       left_join(select(TRD_neu%>%filter(!is.na(BDF)),
         all_of(c("BDF-Fläche"="BDF","Horizont","soliTOC"))),
         by=c("BDF-Fläche","Horizont","Tiefe von", "Tiefe bis"))%>%
      mutate(TOC_budget=soliTOC$TOC/100 #gC/g
     *`TRD g/cm3`# gC/cm3
     *1000#kg/m³
     *10#t/ha*m
     *(abs(Hz_bis-Hz_von)/100))%>%
       #aggregating budget to maxDepth
       mutate(TOC_budget=case_when(
         Hz_bis<=maxDepth~TOC_budget,
         Hz_bis>maxDepth&Hz_von<maxDepth~
           TOC_budget/(Hz_bis-Hz_von)*(maxDepth-Hz_von),
         Hz_bis>maxDepth~0
         )
      )%>%
       
       group_by(BDF=`BDF-Fläche`,Position=rep(c(1:5),13))%>%
       summarise(TOC_budget_sum=sum(TOC_budget))%>%
            summarise(
                 TOC_sum_lutroAll_mean=mean(TOC_budget_sum),
                 TOC_sum_lutroAll_max=max(TOC_budget_sum),
                  TOC_sum_lutroAll_min=min(TOC_budget_sum),
                 TOC_sum_lutroAll_n=length(TOC_budget_sum)
    )),
    Typ=rep("Referenz neu",4)
    ),
    data.frame(
    BDF=c("02","23","30","35","23"),
    Typ=c(rep("zReferenz",4),"Quicksampler"),
    Position=rep(NA,5),
    # sums for top 30 cm
    TOC_sum_lutroAll_mean=c(57.4,86.2,127.6,46.4,NA)
  ))%>%
  
  ggplot(aes(x=BDF,group=paste(Typ),y=TOC_sum_lutroAll_mean))+
  geom_col(position = "dodge",col="black",aes(fill=Typ))+
  geom_errorbar(aes(ymin=TOC_sum_lutroAll_min,ymax=TOC_sum_lutroAll_max),position = position_dodge(width=.9),width=.5)+
  geom_text(angle=90,aes(x=BDF,group=Typ,y=10,label=ifelse(is.na(TOC_sum_lutroAll_n),"",paste0("n=",TOC_sum_lutroAll_n))),hjust = .5,vjust=.5,
            position=position_dodge(width=.925),size = unit(4,"pt"))+
  theme_pubr()+
  scale_fill_manual(breaks=c("Quicksampler","Rammkern","Referenz neu","zReferenz"),values=colorblind_safe_colors[c(2:4,7)],
                    labels=c("Quicksampler","Rammkern","Referenz neu","Referenz"))+
  ylab(expression("TOC [T C "*ha^-1*"]"))+
  xlab("BDF")+
  ggtitle(label=paste0("0-",maxDepth," cm"),subtitle="Gesamt-TRD")
  ),
 
#FB only
(

BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q")&Tiefe_von>=0)%>%
   left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))%>%
  mutate(
   TOC_budget_lutroFB=TOC/100 #gC/g
     *Lutro_density_FB# gC/cm3
     *1000#kg/m³
     *10#t/ha*m
     *(abs(Tiefe_von-Tiefe_bis)/100)
   )%>%
  filter(Tiefe_bis<=maxDepth)%>%
  group_by(BDF,Typ,Tiefe_von,Tiefe_bis,Position)%>%
  summarise(across(contains("TOC_budget"),.fns=mean))%>%#(TOC_budget,na.rm = T))%>%
  group_by(BDF,Typ,Position)%>%
  summarise(
            TOC_sum_lutroFB=sum(TOC_budget_lutroFB)
)%>%
  group_by(BDF,Typ)%>%
  summarise(
    TOC_sum_lutroFB_mean=mean(TOC_sum_lutroFB),
    TOC_sum_lutroFB_max=max(TOC_sum_lutroFB),
    TOC_sum_lutroFB_min=min(TOC_sum_lutroFB),
    TOC_sum_lutroFB_n=length(TOC_sum_lutroFB)
  )%>%
  # reference data 
  rbind(data.frame(
    (Lagerungsdichte_Referenz_neu%>%
       left_join(select(TRD_neu%>%filter(!is.na(BDF)),
         all_of(c("BDF-Fläche"="BDF","Horizont","soliTOC"))),
         by=c("BDF-Fläche","Horizont","Tiefe von", "Tiefe bis"))%>%
      mutate(TOC_budget=soliTOC$TOC/100 #gC/g
     *`TRD g/cm3`# gC/cm3
     *1000#kg/m³
     *10#t/ha*m
     *(abs(Hz_bis-Hz_von)/100))%>%
       #aggregating budget to maxDepth
       mutate(TOC_budget=case_when(
         Hz_bis<=maxDepth~TOC_budget,
         Hz_bis>maxDepth&Hz_von<maxDepth~
           TOC_budget/(Hz_bis-Hz_von)*(maxDepth-Hz_von),
         Hz_bis>maxDepth~0
         )
      )%>%
       
       group_by(BDF=`BDF-Fläche`,Position=rep(c(1:5),13))%>%
       summarise(TOC_budget_sum=sum(TOC_budget))%>%
            summarise(
                 TOC_sum_lutroFB_mean=mean(TOC_budget_sum),
                 TOC_sum_lutroFB_max=max(TOC_budget_sum),
                  TOC_sum_lutroFB_min=min(TOC_budget_sum),
                 TOC_sum_lutroFB_n=length(TOC_budget_sum)
    )),
    Typ=rep("Referenz neu",4)
    ),
    data.frame(
    BDF=c("02","23","30","35","23"),
    Typ=c(rep("zReferenz",4),"Quicksampler"),
    Position=rep(NA,5),
    # sums for top 30 cm
    TOC_sum_lutroFB_mean=c(57.4,86.2,127.6,46.4,NA)
  ))%>%
  
  ggplot(aes(x=BDF,group=paste(Typ),y=TOC_sum_lutroFB_mean))+
  geom_col(position = "dodge",col="black",aes(fill=Typ))+
  geom_errorbar(aes(ymin=TOC_sum_lutroFB_min,ymax=TOC_sum_lutroFB_max),position = position_dodge(width=.9),width=.5)+
  geom_text(angle=90,aes(x=BDF,group=Typ,y=10,label=ifelse(is.na(TOC_sum_lutroFB_n),"",paste0("n=",TOC_sum_lutroFB_n))),hjust = .5,vjust=.5,
            position=position_dodge(width=.925),size = unit(4,"pt"))+
  theme_pubr()+
  scale_fill_manual(breaks=c("Quicksampler","Rammkern","Referenz neu","zReferenz"),values=colorblind_safe_colors[c(2:4,7)],
                    labels=c("Quicksampler","Rammkern","Referenz neu","Referenz"))+
  ylab(expression("TOC [T C "*ha^-1*"]"))+
  xlab("BDF")+
  ggtitle(label=paste0("0-",maxDepth," cm"),subtitle="Feinboden-TRD")
  ),common.legend = T
)
 )
  dev.off()
}


#barplot aggregated with errorbar 50####
{
  maxDepth=50 # check if RK / QS depth is avail for all cores
svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/TOC_budget_full_50.svg"),width = 10,height = 4)
 plot(
   ggarrange(
 (
BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q")&Tiefe_von>=0)%>%
   left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))%>%
  mutate(
   TOC_budget_lutroAll=TOC/100 #gC/g
     *Lutro_density_all# gC/cm3
     *1000#kg/m³
     *10#t/ha*m
     *(abs(Tiefe_von-Tiefe_bis)/100)
   )%>% 
  filter(Tiefe_bis<=maxDepth&!(BDF=="23"&Position=="P1"))%>%
  group_by(BDF,Typ,Tiefe_von,Tiefe_bis,Position)%>%
  summarise(across(contains("TOC_budget"),.fns=mean))%>%#(TOC_budget,na.rm = T))%>%
  group_by(BDF,Typ,Position)%>%
  summarise(
            TOC_sum_lutroAll=sum(TOC_budget_lutroAll)
)%>%
  group_by(BDF,Typ)%>%
  summarise(
    TOC_sum_lutroAll_mean=mean(TOC_sum_lutroAll),
    TOC_sum_lutroAll_max=max(TOC_sum_lutroAll),
    TOC_sum_lutroAll_min=min(TOC_sum_lutroAll),
    TOC_sum_lutroAll_n=length(TOC_sum_lutroAll)
  )%>%
  # reference data 
  rbind(data.frame(
    (Lagerungsdichte_Referenz_neu%>%
       left_join(select(TRD_neu%>%filter(!is.na(BDF)),
         all_of(c("BDF-Fläche"="BDF","Horizont","soliTOC"))),
         by=c("BDF-Fläche","Horizont","Tiefe von", "Tiefe bis"))%>%
      mutate(TOC_budget=soliTOC$TOC/100 #gC/g
     *`TRD g/cm3`# gC/cm3
     *1000#kg/m³
     *10#t/ha*m
     *(abs(Hz_bis-Hz_von)/100))%>%
       #aggregating budget to maxDepth
       mutate(TOC_budget=case_when(
         Hz_bis<=maxDepth~TOC_budget,
         Hz_bis>maxDepth&Hz_von<maxDepth~
           TOC_budget/(Hz_bis-Hz_von)*(maxDepth-Hz_von),
         Hz_bis>maxDepth~0
         )
      )%>%
       
       group_by(BDF=`BDF-Fläche`,Position=rep(c(1:5),13))%>%
       summarise(TOC_budget_sum=sum(TOC_budget))%>%
            summarise(
                 TOC_sum_lutroAll_mean=mean(TOC_budget_sum),
                 TOC_sum_lutroAll_max=max(TOC_budget_sum),
                  TOC_sum_lutroAll_min=min(TOC_budget_sum),
                 TOC_sum_lutroAll_n=length(TOC_budget_sum)
    )),
    Typ=rep("Referenz neu",4)
    ),
    data.frame(
    BDF=c("02","23","30","35","23"),
    Typ=c(rep("zReferenz",4),"Quicksampler"),
    Position=rep(NA,5),
    # sums for top 30 cm
    TOC_sum_lutroAll_mean=c(75,92.7,206.6,52.3,NA)
    
  ))%>%
  
  ggplot(aes(x=BDF,group=paste(Typ),y=TOC_sum_lutroAll_mean))+
  geom_col(position = "dodge",col="black",aes(fill=Typ))+
  geom_errorbar(aes(ymin=TOC_sum_lutroAll_min,ymax=TOC_sum_lutroAll_max),position = position_dodge(width=.9),width=.5)+
  geom_text(angle=90,aes(x=BDF,group=Typ,y=15,label=ifelse(is.na(TOC_sum_lutroAll_n),"",paste0("n=",TOC_sum_lutroAll_n))),hjust = .5,vjust=.5,
            position=position_dodge(width=.925),size = unit(4,"pt"))+
  theme_pubr()+
  scale_fill_manual(breaks=c("Quicksampler","Rammkern","Referenz neu","zReferenz"),values=colorblind_safe_colors[c(2:4,7)],
                    labels=c("Quicksampler","Rammkern","Referenz neu","Referenz"))+
  ylab(expression("TOC [T C "*ha^-1*"]"))+
  xlab("BDF")+
  ggtitle(label=paste0("0-",maxDepth," cm"),subtitle="Gesamt-TRD")
),
 
#FB only
(

BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q")&Tiefe_von>=0)%>%
   left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))%>%
  mutate(
   TOC_budget_lutroFB=TOC/100 #gC/g
     *Lutro_density_FB# gC/cm3
     *1000#kg/m³
     *10#t/ha*m
     *(abs(Tiefe_von-Tiefe_bis)/100)
   )%>%
  filter(Tiefe_bis<=maxDepth&!(BDF=="23"&Position=="P1"))%>%
  group_by(BDF,Typ,Tiefe_von,Tiefe_bis,Position)%>%
  summarise(across(contains("TOC_budget"),.fns=mean))%>%#(TOC_budget,na.rm = T))%>%
  group_by(BDF,Typ,Position)%>%
  summarise(
            TOC_sum_lutroFB=sum(TOC_budget_lutroFB)
)%>%
  group_by(BDF,Typ)%>%
  summarise(
    TOC_sum_lutroFB_mean=mean(TOC_sum_lutroFB),
    TOC_sum_lutroFB_max=max(TOC_sum_lutroFB),
    TOC_sum_lutroFB_min=min(TOC_sum_lutroFB),
    TOC_sum_lutroFB_n=length(TOC_sum_lutroFB)
  )%>%
  # reference data 
  rbind(data.frame(
    (Lagerungsdichte_Referenz_neu%>%
       left_join(select(TRD_neu%>%filter(!is.na(BDF)),
         all_of(c("BDF-Fläche"="BDF","Horizont","soliTOC"))),
         by=c("BDF-Fläche","Horizont","Tiefe von", "Tiefe bis"))%>%
      mutate(TOC_budget=soliTOC$TOC/100 #gC/g
     *`TRD g/cm3`# gC/cm3
     *1000#kg/m³
     *10#t/ha*m
     *(abs(Hz_bis-Hz_von)/100))%>%
       #aggregating budget to maxDepth
       mutate(TOC_budget=case_when(
         Hz_bis<=maxDepth~TOC_budget,
         Hz_bis>maxDepth&Hz_von<maxDepth~
           TOC_budget/(Hz_bis-Hz_von)*(maxDepth-Hz_von),
         Hz_bis>maxDepth~0
         )
      )%>%
       
       group_by(BDF=`BDF-Fläche`,Position=rep(c(1:5),13))%>%
       summarise(TOC_budget_sum=sum(TOC_budget))%>%
            summarise(
                 TOC_sum_lutroFB_mean=mean(TOC_budget_sum),
                 TOC_sum_lutroFB_max=max(TOC_budget_sum),
                  TOC_sum_lutroFB_min=min(TOC_budget_sum),
                 TOC_sum_lutroFB_n=length(TOC_budget_sum)
    )),
    Typ=rep("Referenz neu",4)
    ),
    data.frame(
    BDF=c("02","23","30","35","23"),
    Typ=c(rep("zReferenz",4),"Quicksampler"),
    Position=rep(NA,5),
    # sums for top 30 cm
    TOC_sum_lutroFB_mean=c(75,92.7,206.6,52.3,NA)
  ))%>%
  
  ggplot(aes(x=BDF,group=paste(Typ),y=TOC_sum_lutroFB_mean))+
  geom_col(position = "dodge",col="black",aes(fill=Typ))+
  geom_errorbar(aes(ymin=TOC_sum_lutroFB_min,ymax=TOC_sum_lutroFB_max),position = position_dodge(width=.9),width=.5)+
  geom_text(angle=90,aes(x=BDF,group=Typ,y=15,label=ifelse(is.na(TOC_sum_lutroFB_n),"",paste0("n=",TOC_sum_lutroFB_n))),hjust = .5,vjust=.5,
            position=position_dodge(width=.925),size = unit(4,"pt"))+
  theme_pubr()+
  scale_fill_manual(breaks=c("Quicksampler","Rammkern","Referenz neu","zReferenz"),values=colorblind_safe_colors[c(2:4,7)],
                    labels=c("Quicksampler","Rammkern","Referenz neu","Referenz"))+
  ylab(expression("TOC [T C "*ha^-1*"]"))+
  xlab("BDF")+
  ggtitle(label=paste0("0-",maxDepth," cm"),subtitle="Feinboden-TRD")
  ),common.legend = T
)
 )
  dev.off()
}



#barplot aggregated with errorbar 50cm ####
{
svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/TOC_budget_full.svg"),width = 8,height = 4)
  plot(
(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name")))%>%
  mutate(
    TOC_budget_lutroFB=
       TOC/100 #gC/g
     *Lutro_density_FB# gC/cm3
     *1000#kg/m³
     *10#t/ha*m
     *(abs(Tiefe_von-Tiefe_bis)/100),
     
   TOC_budget_lutroAll=TOC/100 #gC/g
     *Lutro_density_all# gC/cm3
     *1000#kg/m³
     *10#t/ha*m
     *(abs(Tiefe_von-Tiefe_bis)/100),
     
   TOC_budget_atroFB=
       TOC/100 #gC/g
     *Atro_density_FB# gC/cm3
     *1000#kg/m³
     *10#t/ha*m
     *(abs(Tiefe_von-Tiefe_bis)/100),
     
   TOC_budget_atroAll=TOC/100 #gC/g
     *Atro_density_all# gC/cm3
     *1000#kg/m³
     *10#t/ha*m
     *(abs(Tiefe_von-Tiefe_bis)/100)
   )%>%
  filter(Tiefe_bis<=50&!(BDF=="23"&Position=="P1"))%>% # 1 RK @ BDF23 only to 40 cm - exclude
  group_by(BDF,Typ,Tiefe_von,Tiefe_bis,Position)%>%
  summarise(across(contains("TOC_budget"),.fns=mean))%>%#(TOC_budget,na.rm = T))%>%
  group_by(BDF,Typ,Position)%>%
  summarise(TOC_sum_lutroFB=sum(TOC_budget_lutroFB),
            TOC_sum_lutroAll=sum(TOC_budget_lutroAll),
            TOC_sum_atroFB=sum(TOC_budget_atroFB),
            TOC_sum_atroAll=sum(TOC_budget_atroAll))%>%
  group_by(BDF,Typ)%>%
  summarise(
    TOC_sum_lutroFB_mean=mean(TOC_sum_lutroFB),
    TOC_sum_lutroFB_max=max(TOC_sum_lutroFB),
    TOC_sum_lutroFB_min=min(TOC_sum_lutroFB),
    TOC_sum_lutroFB_n=length(TOC_sum_lutroFB),
    
    TOC_sum_lutroAll_mean=mean(TOC_sum_lutroAll),
    TOC_sum_lutroAll_max=max(TOC_sum_lutroAll),
    TOC_sum_lutroAll_min=min(TOC_sum_lutroAll),
    TOC_sum_lutroAll_n=length(TOC_sum_lutroAll),
    
    TOC_sum_atroFB_mean=mean(TOC_sum_atroFB),
    TOC_sum_atroFB_max=max(TOC_sum_atroFB),
    TOC_sum_atroFB_min=min(TOC_sum_atroFB),
    TOC_sum_atroFB_n=length(TOC_sum_atroFB),
    
    TOC_sum_atroAll_mean=mean(TOC_sum_atroAll),
    TOC_sum_atroAll_max=max(TOC_sum_atroAll),
    TOC_sum_atroAll_min=min(TOC_sum_atroAll),
    TOC_sum_atroAll_n=length(TOC_sum_atroAll)
    
  )%>%
  
  # reference data 
  rbind(
    data.frame(
    BDF=c("02","23","30","35","23"),
    Typ=c(rep("Referenz",4),"Quicksampler"),
    Position=rep(NA,5),
    # sums for top 50 cm
    TOC_sum_lutroFB_mean=c(75,92.7,206.6,52.3,NA),  #all the same, but for easier ggplot flow
    TOC_sum_lutroAll_mean=c(75,92.7,206.6,52.3,NA),
    TOC_sum_atroFB_mean=c(575,92.7,206.6,52.3,NA),
    TOC_sum_atroAll_mean=c(75,92.7,206.6,52.3,NA))
  )%>%
  
  ggplot(aes(x=BDF,group=paste(Typ),y=TOC_sum_lutroFB_mean))+
  geom_col(position = "dodge",col="black",aes(fill=Typ))+
  geom_errorbar(aes(ymin=TOC_sum_lutroFB_min,ymax=TOC_sum_lutroFB_max),position = position_dodge(width=.9),width=.5)+
  geom_text(angle=0,aes(x=BDF,group=Typ,y=10,label=ifelse(is.na(TOC_sum_lutroFB_n),"",paste0("n=",TOC_sum_lutroFB_n))),hjust = .5,vjust=.5,
            position=position_dodge(width=.9),size = unit(4,"pt"))+
  theme_pubr()+
  scale_fill_manual(breaks=c("Quicksampler","Rammkern","Referenz"),values=colorblind_safe_colors[2:4])+
  ylab(expression("TOC [T C "*ha^-1*"]"))+
  xlab("BDF")
  )
  dev.off()
}




Lagerungsdichte_Referenz_BUDGET=read_excel("~/GitHub/BDF/BDF-SSL/5_Provided_BDF-Database/Adam-2024_Lagerungsdichten_Referenz.xlsx",sheet = "Tabelle2", na = "NA")

Lagerungsdichte_Referenz_BUDGET%>%mutate(CORG_budget=
           CORG/100 #gC/g
         *TRD# gC/cm3
         *1000#kg/m³
         *10 #t/ha*m
         *(abs(Tiefe_bis-Tiefe_von)/100))->tmp

#'Refernz Budgets 
#'
#'BDF02:       0-30  0-50
#'00-15 29.2 | 29.2  29.2
#'15-32 32   | 28.2  32
#'32-50 13.8 |       13.8
#'          || 57.4  75
#'
#'BDF23:       0-30  0-50
#'00-20 78   | 78    78
#'20-70 42.5 | 8.5   14.7
#'          || 86.5  92.7
#'
#'BDF30:       0-30  0-50
#'00-10 45.9 | 45.9  45.9
#'10-45 143  | 81.7  143
#'45-90 149  |       17.7
#'          ||127.6  206.6
#'
#'BDF35:       0-30  0-50
#'00-20 8.82 | 28    8.82
#'20-30 18.4 | 18.4  18.4  # estimated from Ld
#'30-60 8.82 |       5.9   
#'          || 46.4  52.3
#'


ggarrange(plt30,plt50)

```
# ROC TIC900
```{r}
# ROC/TOC400 ratio
{
svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_ROC-ratio_full.svg"),width = 8,height = 8)
      plot(ggplot(
      )+
    #manual gridlines
 #   geom_hline(yintercept = seq(.6,2.8,.1),col="grey15",linewidth=.025)+
  #  geom_vline(xintercept = seq(0,150,10),col="grey15",linewidth=.025)+
   # geom_vline(xintercept = 0,linewidth=.2,col="black")+

  
# RK PS QS
    geom_line(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q","P")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))), 
      aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=ROC/TOC,   # same as weighed for TOC determination
        linetype=Typ,
        alpha=Typ,
        col=Typ,
        group=paste(BDF,Position,Typ)),
              linewidth=.25)+
    geom_smooth(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q","P")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))), 
                aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=ROC/TOC400,
        linetype=Typ,
        alpha=Typ,
        col=Typ,
        group=paste(BDF,Typ)),
        se=F,linewidth=1,inherit.aes = T)+
  #formatting
        coord_flip(xlim=c(150,0))+
    scale_x_reverse("Tiefe [cm]",
                    breaks=seq(0,150,50),
                    minor_breaks=seq(0,150,10),
                   )+
    #scale_color_manual(breaks=c("02","23","30","35"),values=colorblind_safe_colors[c(2:4,8)],labels=paste("BDF",c("02","23","30","35")))+
    scale_linetype_manual("",
                          breaks=c("neu","BDF-Referenz","Profilspaten","Quicksampler","Rammkern"),
                          values=c("solid","solid","dotdash","dashed","dotted"),
                          labels=c("Referenz neu","Referenz","PS","QS","RK"))+
    scale_alpha_manual("",
                       breaks=c("neu","BDF-Referenz","Profilspaten","Quicksampler","Rammkern"),
                       values=c(1,1,1,1,1),
                       labels=c("Referenz neu","Referenz","PS","QS","RK"))+
    scale_color_manual("",
                       breaks=c("neu","BDF-Referenz","Profilspaten","Quicksampler","Rammkern"),
                       values = c(colorblind_safe_colors[c(6,7)],"black","black","black"),
                       labels=c("Referenz neu","Referenz","PS","QS","RK"))+
    ylab("ROC ratio [M-%/M-%]")+
    theme_pubr()+
    theme(legend.box="vertical",
          #legend.position = "top"
          #panel.grid = element_line(colour = "grey"),
          #panel.grid.major = element_line(colour = "grey",linewidth = 1),
          #panel.grid.minor = element_line(colour = "grey",linewidth = 1,linetype = "solid")
          )+
  facet_wrap(facets = vars(BDF),labeller = BDF_labeller,scales = "free",nrow = 2))
dev.off()
}


# averaged ratios per BDF
{
  svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_ROC-ratio_avg.svg"),width = 8,height = 5)
plot(
  ggplot()+ 
        geom_pointrange(data=(BDF_frisch$TRD%>%
                          filter(sample_id%>%
                                   substr(2,2)%in%c("R","Q","P")&Tiefe_von>=0)%>%
                            left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))%>%
                      group_by(Tiefe=(Tiefe_bis+Tiefe_von)/2,BDF)%>%
                      summarise(min_ratio=min(ROC/TOC400),                                                                              mean_ratio=mean(ROC/TOC400),
                                max_ratio=max(ROC/TOC400))
                          ),width=.1,
                    aes(
            x=Tiefe,
            y=mean_ratio,
            ymin=min_ratio,
            ymax=max_ratio,
            col=BDF,
            #shape="Mittel"
            ),
            shape=19,
            size=.2,
            alpha=.5
            )+
 geom_point(data=(BDF_frisch$TRD%>%
                          filter(sample_id%>%
                                   substr(2,2)%in%c("R","Q","P")&Tiefe_von>=0)%>%
                            left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))%>%
                      group_by(Tiefe=(Tiefe_bis+Tiefe_von)/2,BDF)%>%
                      summarise(median_ratio=median(ROC/TOC400))
                          ),width=.1,
                    aes(
            x=Tiefe,
            y=median_ratio,
            col=BDF,
            #shape="Median"
            ),
            shape=4,
            size=2,stroke=1,
            alpha=.5
            )+
         geom_smooth(data=(BDF_frisch$TRD%>%
                          filter(sample_id%>%
                                   substr(2,2)%in%c("R","Q","P")&Tiefe_von>=0)%>%
                            left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))#%>%filter(!(BDF=="23"&Tiefe_von>=40&ROC>.1))
                          ), 
                    aes(
            x=(Tiefe_bis+Tiefe_von)/2,
            y=ROC/TOC400,
            col=BDF,
            #linetype="ROC ratio"
            ),
            se=F,linewidth=1.5,inherit.aes = T)+

      #formatting
    coord_flip()+
    scale_x_reverse("Tiefe [cm]",
                    breaks=seq(0,150,50),
                    minor_breaks=seq(0,150,10)) +
     scale_color_manual("",
                       breaks=c("02","23","30","35"),
                       values = c(colorblind_safe_colors),
                       labels=BDF_labeller_manual)+ # ! no check for correct order
   #paste0("BDF",c("02","23","30","35")))+
     #scale_shape_manual("",breaks=c("Mittel","Median"),values = c(19,4))+
    ylab("ROC ratio [M-%/M-%]")+
    theme_pubr()+
    theme(legend.direction="vertical"
          #legend.position = "top"
          #panel.grid = element_line(colour = "grey"),
          #panel.grid.major = element_line(colour = "grey",linewidth = 1),
          #panel.grid.minor = element_line(colour = "grey",linewidth = 1,linetype = "solid")
          )+scale_y_log10() # 1xNA by log is due to 1 weired measurement where all fractions are 0; should rm at some point / remeasure
)
dev.off()
}

# texture

 ggplot()+ 
        geom_line(data=(BDF_frisch$TRD%>%
                          filter(sample_id%>%
                                   substr(2,2)%in%c("G")&Tiefe_von>=0)%>%
                            left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))%>%
                            left_join(BDF_frisch$texture,by=c("sample_id"="Proben-Nr."))%>%
                          pivot_longer(cols = all_of(c("S","U","T")))),
                    aes(
            x=(Tiefe_bis+Tiefe_von)/2,
            y=value,
            linetype=name,
            col=BDF,
            #shape="Mittel"
            ),
            #shape=19,
            #size=.2,
            #alpha=.5
            )+
 
      #formatting
    coord_flip()+
    scale_x_reverse("Tiefe [cm]",
                    breaks=seq(0,150,50),
                    minor_breaks=seq(0,150,10)) +
     scale_color_manual("",
                       breaks=c("02","23","30","35"),
                       values = c(colorblind_safe_colors),
                       labels=paste0("BDF",c("02","23","30","35")))+
     #scale_shape_manual("",breaks=c("Mittel","Median"),values = c(19,4))+
   # ylab("ROC ratio [M-%/M-%]")+
    theme_pubr()+
    theme(legend.box="vertical"
          #legend.position = "top"
          #panel.grid = element_line(colour = "grey"),
          #panel.grid.major = element_line(colour = "grey",linewidth = 1),
          #panel.grid.minor = element_line(colour = "grey",linewidth = 1,linetype = "solid")
          )#+scale_y_log10()




# for report ####
{
svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_fractions_frisch_full.svg"),width = 8,height = 8)
      plot(ggplot(
      )+
    #manual gridlines
 #   geom_hline(yintercept = seq(.6,2.8,.1),col="grey15",linewidth=.025)+
  #  geom_vline(xintercept = seq(0,150,10),col="grey15",linewidth=.025)+
   # geom_vline(xintercept = 0,linewidth=.2,col="black")+


  #TOC400
    geom_line(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q","P")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))), 
      aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=TOC400/10,   # same as weighed for TOC determination
        linetype=Typ,
        col="TOC400",
        group=paste(BDF,Position,Typ)),
              linewidth=.25)+
    geom_smooth(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q","P")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))), 
                aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=TOC400/10,
        linetype=Typ,
        col="TOC400",
        group=paste(BDF,Typ)),
        se=F,linewidth=1,inherit.aes = T)+
  
  #ROC
      geom_line(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q","P")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))), 
      aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=ROC,   # same as weighed for TOC determination
        linetype=Typ,
        col="ROC",
        group=paste(BDF,Position,Typ)),
              linewidth=.25)+
    geom_smooth(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q","P")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))), 
                aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=ROC,
        linetype=Typ,
        col="ROC",
        group=paste(BDF,Typ)),
        se=F,linewidth=1,inherit.aes = T)+
   
  #TIC900
      geom_line(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q","P")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))), 
      aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=TIC900,   # same as weighed for TOC determination
        linetype=Typ,
        col="TIC900",
        group=paste(BDF,Position,Typ)),
              linewidth=.25)+
    geom_smooth(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q","P")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))), 
                aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=TIC900,
        linetype=Typ,
        col="TIC900",
        group=paste(BDF,Typ)),
        se=F,linewidth=1,inherit.aes = T)+
  #formatting
    coord_flip(xlim=c(150,0),ylim=c(0,.6))+
    scale_x_reverse("Tiefe [cm]",
                    breaks=seq(0,150,50),
                    minor_breaks=seq(0,150,10))+
    #scale_color_manual(breaks=c("02","23","30","35"),values=colorblind_safe_colors[c(2:4,8)],labels=paste("BDF",c("02","23","30","35")))+
    scale_linetype_manual("",
                          breaks=c("Profilspaten","Quicksampler","Rammkern"),
                          values=c("dotdash","dashed","dotted"),
                          labels=c("PS","QS","RK"))+
   
    scale_color_manual("",
                       breaks=c("TOC400","ROC","TIC900"),
                       values = c(colorblind_safe_colors[c(4,6,7)]),
                       labels=c("TOC400","ROC","TIC900")
                       )+
    scale_y_continuous("ROC [M-%], TIC900 [M-%]",sec.axis = sec_axis("TOC400 [M-%]",transform = ~.*10))+
    theme_pubr()+
    theme(legend.box="vertical",
          legend.position = "none"
          #panel.grid = element_line(colour = "grey"),
          #panel.grid.major = element_line(colour = "grey",linewidth = 1),
          #panel.grid.minor = element_line(colour = "grey",linewidth = 1,linetype = "solid")
          )+
  facet_wrap(facets = vars(BDF),labeller = BDF_labeller,scales = "free",nrow = 2))
dev.off()
}
```

# LEGEND of vertical profiles
```{r}
{
svg("C:/Users/adam/Documents/GitHub/R_main/R_main/temp/bdf_frisch_vertical_profile_LEGEND.svg",width=5,height=5)
   plot(ggplot(
      )+
    #manual gridlines
 #   geom_hline(yintercept = seq(.6,2.8,.1),col="grey15",linewidth=.025)+
  #  geom_vline(xintercept = seq(0,150,10),col="grey15",linewidth=.025)+
   # geom_vline(xintercept = 0,linewidth=.2,col="black")+
# BDF Ref  
    geom_line(data = filter(Lagerungsdichte_Referenz,Tiefe<100),
              aes(x=Tiefe,
                  y=CORG, # 10e-2 g/cm³ | 1ha =10e8 cm² , 1 T = 10^6 g -> 1 10^-2g/cm³ = 1 T/ha*cm
                  col="BDF-Referenz",
                  linetype="BDF-Referenz",
                  alpha="BDF-Referenz"),
              linewidth=1,
             )+

  
# RK PS QS
    geom_line(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q","P")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))), 
      aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=TOC,   # same as weighed for TOC determination
        linetype=Typ,
        alpha=Typ,
        col=Typ,
        group=paste(BDF,Position,Typ)),
              linewidth=.25)+
    geom_smooth(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q","P")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))), 
                aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=TOC,
        linetype=Typ,
        alpha=Typ,
        col=Typ,
        group=paste(BDF,Typ)),
        se=F,linewidth=1,inherit.aes = T)+
  
   geom_point(data=(TRD_neu%>%left_join(TRD_neu$soliTOC,by=c("sample_id"="Name"))),
    aes(
      x=Tiefe_avg,
      y=TOC,
      col="neu",
      linetype="neu",
      alpha="neu"
    ),
    size=2,
    shape=4,
    stroke=2)+
  #formatting
    coord_flip()+
    scale_x_reverse("Tiefe [cm]",
                    breaks=seq(0,150,50),
                    minor_breaks=seq(0,150,10))+
    #scale_color_manual(breaks=c("02","23","30","35"),values=colorblind_safe_colors[c(2:4,8)],labels=paste("BDF",c("02","23","30","35")))+
    scale_linetype_manual("",
                          breaks=c("neu","BDF-Referenz","Profilspaten","Quicksampler","Rammkern"),
                          values=c("solid","solid","dotdash","dashed","dotted"),
                          labels=c("Referenz Frischprobenahme","Referenz Erstaufnahme","Profilspaten","Quicksampler","Rammkern"))+
    scale_alpha_manual("",
                       breaks=c("neu","BDF-Referenz","Profilspaten","Quicksampler","Rammkern"),
                       values=c(1,1,1,1,1),
                       labels=c("Referenz Frischprobenahme","Referenz Erstaufnahme","Profilspaten","Quicksampler","Rammkern"))+
    scale_color_manual("",
                       breaks=c("neu","BDF-Referenz","Profilspaten","Quicksampler","Rammkern"),
                       values = c(colorblind_safe_colors[c(6,7)],"black","black","black"),
                       labels=c("Referenz Frischprobenahme","Referenz Erstaufnahme","Profilspaten","Quicksampler","Rammkern"))+
    ylab("TOC [M-%]")+
    theme_pubr()+
    theme(legend.box="vertical",
          legend.position = "right"
          #panel.grid = element_line(colour = "grey"),
          #panel.grid.major = element_line(colour = "grey",linewidth = 1),
          #panel.grid.minor = element_line(colour = "grey",linewidth = 1,linetype = "solid")
          ))
dev.off()
}
```


# fractions budget


```{r}
{
svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_fractions-budget_frisch_full.svg"),width = 8,height = 8)
      plot(ggplot(
      )+
    #manual gridlines
 #   geom_hline(yintercept = seq(.6,2.8,.1),col="grey15",linewidth=.025)+
  #  geom_vline(xintercept = seq(0,150,10),col="grey15",linewidth=.025)+
   # geom_vline(xintercept = 0,linewidth=.2,col="black")+


  #TOC400
    geom_line(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))), 
      aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=Lutro_density_FB*TOC400/10,   # same as weighed for TOC determination
        linetype=Typ,
        col="TOC400",
        group=paste(BDF,Position,Typ)),
              linewidth=.25)+
    geom_smooth(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))), 
                aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=Lutro_density_FB*TOC400/10,
        linetype=Typ,
        col="TOC400",
        group=paste(BDF,Typ)),
        se=F,linewidth=1,inherit.aes = T)+
  
  #ROC
      geom_line(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))), 
      aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=Lutro_density_FB*ROC,   # same as weighed for TOC determination
        linetype=Typ,
        col="ROC",
        group=paste(BDF,Position,Typ)),
              linewidth=.25)+
    geom_smooth(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))), 
                aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=Lutro_density_FB*ROC,
        linetype=Typ,
        col="ROC",
        group=paste(BDF,Typ)),
        se=F,linewidth=1,inherit.aes = T)+
   
  #TIC900
      geom_line(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))), 
      aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=Lutro_density_FB*TIC900,   # same as weighed for TOC determination
        linetype=Typ,
        col="TIC900",
        group=paste(BDF,Position,Typ)),
              linewidth=.25)+
    geom_smooth(data=(BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q")&Tiefe_von>=0)%>%left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))), 
                aes(
        x=(Tiefe_bis+Tiefe_von)/2,
        y=Lutro_density_FB*TIC900,
        linetype=Typ,
        col="TIC900",
        group=paste(BDF,Typ)),
        se=F,linewidth=1,inherit.aes = T)+
  #formatting
    coord_flip()+
    scale_x_reverse("Tiefe [cm]",
                    breaks=seq(0,150,50),
                    minor_breaks=seq(0,150,10))+
    #scale_color_manual(breaks=c("02","23","30","35"),values=colorblind_safe_colors[c(2:4,8)],labels=paste("BDF",c("02","23","30","35")))+
    scale_linetype_manual("",
                          breaks=c("Quicksampler","Rammkern"),
                          values=c("dotdash","dashed","dotted"),
                          labels=c("QS","RK"))+
   
    scale_color_manual("",
                       breaks=c("TOC400","ROC","TIC900"),
                       values = c(colorblind_safe_colors[c(4,6,7)]),
                       labels=c("TOC400","ROC","TIC900")
                       )+
    scale_y_continuous(expression("ROC [T "*ha^-1*cm^-1*"], TIC900 [T "*ha^-1*cm^-1*"]"),sec.axis = sec_axis(expression("TOC400 [T "*ha^-1*cm^-1*"]"),transform = ~.*10))+
    theme_pubr()+
    theme(legend.box="vertical",
          #legend.position = "top"
          #panel.grid = element_line(colour = "grey"),
          #panel.grid.major = element_line(colour = "grey",linewidth = 1),
          #panel.grid.minor = element_line(colour = "grey",linewidth = 1,linetype = "solid")
          )+
  facet_wrap(facets = vars(BDF),labeller = BDF_labeller,scales = "free",nrow = 2))
dev.off()
}

```




# Local heterogenity
```{r}
require(sp)
require(gstat)
# TOC budget
maxDepth=40
BDF_frisch$TRD%>%filter(sample_id%>%substr(2,2)%in%c("R","Q")&Tiefe_von>=0)%>%
   left_join(BDF_frisch$soliTOC,by=c("sample_id"="Name"))%>%
  mutate(
   TOC_budget_lutroFB=TOC/100 #gC/g
     *Lutro_density_FB# gC/cm3
     *1000#kg/m³
     *10#t/ha*m
     *(abs(Tiefe_von-Tiefe_bis)/100)
   )%>%
  filter(Tiefe_bis<=maxDepth&!(BDF=="23"&Position=="P1"))%>%
  group_by(BDF,Typ,Tiefe_von,Tiefe_bis,Position)%>%
  summarise(across(contains("TOC_budget"),.fns=mean))%>%#(TOC_budget,na.rm = T))%>%
  group_by(BDF,Typ,Position)%>%
  summarise(
            TOC_sum_lutroFB=sum(TOC_budget_lutroFB)
)%>%
  transmute(x=case_match(Position,
                                 "Profil"~1,
                                 "Y17"~0,
                                 "Y0.7"~0,
                                 "X0"~0,
                                 "X5"~5,
                                 "X31"~31,
                                 "Profil_2"~1,
                                 "Profil_1"~.8,
                                 "Profil_3"~1.2,
                                 "P1"~.8,
                                 "P2"~1,
                                 "P3"~1.2),    
                    y=case_match(Position,
                                 "Profil"~-.5,
                                 "Y17"~17,
                                 "Y0.7"~.4,
                                 "X0"~0,
                                 "X5"~0,
                                 "X31"~0,
                                 "Profil_2"~-.5,
                                 "Profil_1"~-.5,
                                 "Profil_3"~-.5,
                                 "P1"~-.2,
                                 "P2"~-.2,
                                 "P3"~-.2),
                    #TC=soliTOC$TC,
                    #TOC=soliTOC$TOC,
                    #TOC400=soliTOC$TOC400,
                    #ROC=soliTOC$ROC,
                    #TIC900=soliTOC$TIC900,
            TOC_budget=TOC_sum_lutroFB,   
                    BDF=BDF)%>%#filter(BDF=="35")%>%
  na.omit%>%
tibble()->BDF_frisch_geo

BDF_frisch_geo_semivar=BDF_frisch_geo
coordinates(BDF_frisch_geo_semivar)=~x+y
variogram(data=BDF_frisch_geo_semivar,TOC_budget~1,cutoff=32)%>%plot

svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_frisch_local_heterogenity_TOCbudget40.svg"),width=8,height=5)
ggplot(BDF_frisch_geo,aes(x=sqrt(x^2+y^2),y=TOC_budget,col=BDF))+
  geom_point()+
  geom_smooth(method="lm",formula=y~1)+
  ylab(expression("TOC [T C  "*ha^-1*"]"))+
  xlab("Distanz [m]")+
  theme_pubr()
dev.off()


(
ggplot(BDF_frisch%>%mutate(x=case_match(sampling_data$Position,
                                 "Profil"~1,
                                 "Y17"~0,
                                 "Y0.7"~0,
                                 "X0"~0,
                                 "X5"~5,
                                 "X31"~31,
                                 "Profil_2"~1,
                                 "Profil_1"~.8,
                                 "Profil_3"~1.2,
                                 "P1"~.8,
                                 "P2"~1,
                                 "P3"~1.2),    
                    y=case_match(sampling_data$Position,
                                 "Profil"~-.5,
                                 "Y17"~17,
                                 "Y0.7"~.4,
                                 "X0"~0,
                                 "X5"~0,
                                 "X31"~0,
                                 "Profil_2"~-.5,
                                 "Profil_1"~-.5,
                                 "Profil_3"~-.5,
                                 "P1"~-.2,
                                 "P2"~-.2, "P3"~-.2),
                    BDF=sampling_data$BDF,
                    Tiefe=sampling_data$Tiefe_von+sampling_data$Tiefe_bis/2,
                    )%>%filter(Tiefe<40),
       aes(x=sqrt(x^2+y^2),
           y=soliTOC$TOC,
           col=as.character(paste(BDF,Tiefe))))+
  geom_point()+geom_smooth(se=T,method="loess",span=10)+theme_pubr())#%>%ggplotly()
           

BDF_frisch%>%mutate(x=case_match(sampling_data$Position,
                                 "Profil"~1,
                                 "Y17"~0,
                                 "Y0.7"~0,
                                 "X0"~0,
                                 "X5"~5,
                                 "X31"~31,
                                 "Profil_2"~1,
                                 "Profil_1"~.8,
                                 "Profil_3"~1.2,
                                 "P1"~.8,
                                 "P2"~1,
                                 "P3"~1.2),    
                    y=case_match(sampling_data$Position,
                                 "Profil"~-.5,
                                 "Y17"~17,
                                 "Y0.7"~.4,
                                 "X0"~0,
                                 "X5"~0,
                                 "X31"~0,
                                 "Profil_2"~-.5,
                                 "Profil_1"~-.5,
                                 "Profil_3"~-.5,
                                 "P1"~-.2,
                                 "P2"~-.2, "P3"~-.2),
                    BDF=sampling_data$BDF,
                    Typ=sampling_data$Typ,
                    Tiefe=as.character(sampling_data$Tiefe_von+sampling_data$Tiefe_bis/2),
                    z=as.numeric(Tiefe))%>%
  filter(#BDF=="02"&
           #Typ=="Rammkern"
           )%>%
  group_by(Tiefe)%>%
  mutate(TC_norm=soliTOC$TC/median(soliTOC$TC),
         TOC_norm=soliTOC$TOC/median(soliTOC$TOC),
         TOC400_norm=soliTOC$TOC400/median(soliTOC$TOC400),
         ROC_norm=soliTOC$ROC/median(soliTOC$ROC),
         TIC900_norm=soliTOC$TIC900/median(soliTOC$TIC900),
         TC=soliTOC$TC,
         TOC=soliTOC$TOC,
         TOC400=soliTOC$TOC400,
         ROC=soliTOC$ROC,
         TIC900=soliTOC$TIC900,
         Typ=sampling_data$Typ)->norm_TOC

ggplotly(
norm_TOC%>%group_by(BDF,Tiefe)%>%mutate(n=length(TOC_norm))%>%filter(length(n)>3)%>%
   ggplot(aes(x=sqrt(x^2+y^2),
           y=TOC_norm,
           col=as.character(paste(BDF,Tiefe))))+
  geom_point()+geom_smooth(se=T,method="lm",span=10,alpha=.1)+theme_pubr()#+theme(legend.position = "none")
)

semivar_plots=c()
for( i in c("02","23","30","35")){
BDF_frisch_geo_semivar=norm_TOC%>%filter(Typ=="Profilspaten"&BDF==i)#&Tiefe=="10")
coordinates(BDF_frisch_geo_semivar)=~x+y
v_TOC400=variogram(data=BDF_frisch_geo_semivar,TOC400_norm~x+y,cutoff=35)
v_mod_TOC400=fit.variogram(object = v_TOC400,model = vgm(model = "Nug"))

v_ROC=variogram(data=BDF_frisch_geo_semivar,ROC_norm~x+y,cutoff=35)
v_mod_ROC=fit.variogram(object = v_ROC,model = vgm(model = "Nug"))

v_TIC900=variogram(data=BDF_frisch_geo_semivar,TIC900_norm~x+y,cutoff=35)
v_mod_TIC900=fit.variogram(object = v_TIC900,model = vgm(model = "Nug"))


semivar_plots[[i]]=ggplot()+
  
  geom_point(data=v_TOC400,aes(x=dist,y=gamma,col="TOC400",shape="TOC400"))+
  geom_hline(yintercept = v_mod_TOC400$psill,col=colorblind_safe_colors[4])+
  
  geom_point(data=v_ROC,aes(x=dist,y=gamma,col="ROC",shape="ROC"))+
  geom_hline(yintercept = v_mod_ROC$psill,col=colorblind_safe_colors[6])+
  
  geom_point(data=v_ROC,aes(x=dist,y=gamma,col="TIC900",shape="TIC900"))+
  geom_hline(yintercept = v_mod_ROC$psill,col=colorblind_safe_colors[7],linetype="dashed")+
  
  ylim(c(0,max(c(v_TOC400$gamma,v_ROC$gamma,v_TIC900$gamma))))+
  ggtitle(paste("BDF",i))+
  xlab("Distanz [m]")+
  ylab("Semivarianz")+
  
  
  scale_color_manual("",breaks=c("TOC400","ROC","TIC900"),values=colorblind_safe_colors[c(4,6,7)])+
  scale_shape_discrete("",breaks=c("TOC400","ROC","TIC900"))+
  theme_pubr()
}


svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_frisch_local_heterogenity_semivariance.svg"),width=8,height=5)
ggarrange(plotlist = semivar_plots,common.legend = T)
dev.off()


#plot(v,vmod)
# DRIFTS Predictions
```

# predictions
```{r}
#reload BDF frisch
{
  tmp1=read_rds(paste0(root_dir,"/GitHub/BDF/BDF-SSL/4_datasets/Adam-2024_BDF_frisch_sub-1"))
  tmp2=read_rds(paste0(root_dir,"/GitHub/BDF/BDF-SSL/4_datasets/Adam-2024_BDF_frisch_sub-2"))
  tmp3=read_rds(paste0(root_dir,"/GitHub/BDF/BDF-SSL/4_datasets/Adam-2024_BDF_frisch_sub-3"))
  
  
  BDF_frisch=rbind(
    tmp1,
    tmp2,
    tmp3
  )
  rm(tmp1)
  rm(tmp2)
  rm(tmp3)
}


# Predictions ####

## PLS ####
model_folder="/GitHub/BDF/BDF-SSL/2_models/1_PLS_models/"
pls_prediction_data=tibble(BDF_frisch["sample_id"])
for (i in (read_rds(paste0(root_dir,model_folder,"evaluation")))$eval%>%
     pull(variable)%>%unique # reads evaluation object, pulls unique variables from evaluation$eval$variable 
     ){
  # for i fit best model from set/trans combo. 
  pred=predict_variable( 
    BDF_frisch, 
    model_folder = paste0(root_dir,model_folder),
    prefix = "pls_", # model type, usually
    variable_ = i,
    metric = "test.rmse",
    maximise = F, # set T, e.g. when R2 is used as metric
    restrict = T, # choose optimal model only form sets that are available both in Xu (new data) and Xr (calibrated)
    diss_limit = 2) # limit for outlier flagging
pred_out=data.frame(left_join(pred$predictions,pred$spc_diss),
                    model_name=pred$model_name) # attaches entire column of model name, but easier to handle in workflow than single nested argument
pred_out=data.frame(left_join(pred$predictions,pred$spc_diss),
                    model_name=pred$model_name)  
  pls_prediction_data[[i]]= pred_out
}

saveRDS(pls_prediction_data,paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_frisch_predictions_pls"))



## Cubist ####
model_folder="/GitHub/BDF/BDF-SSL/2_models/2_Cubist_models/"
cubist_prediction_data=tibble(BDF_frisch["sample_id"])
for (i in (read_rds(paste0(root_dir,model_folder,"evaluation")))$eval%>%
     pull(variable)%>%unique # reads evaluation object, pulls unique variables from evaluation$eval$variable 
     ){
  # for i fit best model from set/trans combo. 
  pred=predict_variable( 
    BDF_frisch, 
    model_folder = paste0(root_dir,model_folder),
    prefix = "cubist_", # model type, usually
    variable_ = i,
    metric = "test.rmse",
    maximise = F, # set T, e.g. when R2 is used as metric
    restrict = T, # choose optimal model only form sets that are available both in Xu (new data) and Xr (calibrated)
    diss_limit = 2) # limit for outlier flagging
pred_out= data.frame(left_join(pred$predictions,pred$spc_diss),
                    model_name=pred$model_name) # attaches entire column of model name, but easier to handle in workflow than single nested argument
#pred_out=tibble(sample_id=pred_out$sample_id,data=select(pred_out,-c(sample_id)))
  
  cubist_prediction_data[[i]]= pred_out
}

saveRDS(cubist_prediction_data,paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_frisch_predictions_cubist"))



model_folder="/GitHub/BDF/BDF-SSL/2_models/4_MBL_models_frisch/" # !for MBL, the fitted objects need to be used (not the original fits for the test data)
eval_model_folder="/GitHub/BDF/BDF-SSL/2_models/3_MBL_models_test/"
mbl_prediction_data=tibble(BDF_frisch["sample_id"])

for (i in (read_rds(paste0(root_dir,eval_model_folder,"evaluation")))$eval%>%
     pull(variable)%>%unique # reads evaluation object, pulls unique variables from evaluation$eval$variable 
     ){
  # for i fit best model from set/trans combo. 
  pred=predict_variable( 
    BDF_frisch, 
    model_folder = paste0(root_dir,model_folder),
    eval_model_folder = paste0(root_dir,eval_model_folder),
    prefix = "mbl_", # model type, usually
    variable_ = i,
    metric = "test.rmse",
    maximise = F, # set T, e.g. when R2 is used as metric
    restrict = T, # choose optimal model only form sets that are available both in Xu (new data) and Xr (calibrated)
    diss_limit = 2) # limit for outlier flagging
pred_out=left_join(data.frame(sample_id=BDF_frisch$sample_id),
                   data.frame(left_join(pred$predictions,pred$spc_diss),
                    model_name=pred$model_name),by="sample_id") # attaches entire column of model name, but easier to handle in workflow than single nested argument
#pred_out=tibble(sample_id=pred_out$sample_id,data=select(pred_out,-c(sample_id)))
  # rm LQCO duplicated to enable re-merging
  mbl_prediction_data[[i]]= pred_out[-which(duplicated(pred_out$sample_id)),]
}

saveRDS(mbl_prediction_data,paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_frisch_predictions_mbl"))






BDF_frisch_predictions=BDF_frisch

pls_prediction_data=read_rds(paste0(root_dir,"/GitHub/BDF/BDF-SSL/4_datasets/Adam-2024_BDF_frisch_predictions_pls"))
BDF_frisch_predictions=left_join(BDF_frisch_predictions,
          tibble(
            sample_id=pls_prediction_data$sample_id,
            pls_predictions=select(pls_prediction_data,-c("sample_id"))
                 ),
          by=c("sample_id"))

cubist_prediction_data=read_rds(paste0(root_dir,"/GitHub/BDF/BDF-SSL/4_datasets/Adam-2024_BDF_frisch_predictions_cubist"))

BDF_frisch_predictions=left_join(BDF_frisch_predictions,tibble(sample_id=cubist_prediction_data$sample_id,cubist_predictions=select(cubist_prediction_data,-c("sample_id"))),by=c("sample_id"))

mbl_prediction_data=read_rds(paste0(root_dir,"/GitHub/BDF/BDF-SSL/4_datasets/Adam-2024_BDF_frisch_predictions_mbl"))
BDF_frisch_predictions=left_join(BDF_frisch_predictions,tibble(sample_id=mbl_prediction_data$sample_id,mbl_predictions=select(mbl_prediction_data,-c("sample_id"))),by=c("sample_id"))


```

# all models for carbon run on BDF frisch
```{r}
var_list=c("TOC400","ROC","TIC900","TOC","TC")

### PLS ####
model_folder="/GitHub/BDF/BDF-SSL/2_models/1_PLS_models/"
pls_prediction_data=tibble(BDF_frisch["sample_id"])
for (i in var_list){ 
  for (model_i in list.files(paste0(root_dir,model_folder))[
    which(str_ends(list.files(paste0(root_dir,model_folder)),i))
    ]){
    
    pred=predict_variable( 
      BDF_frisch, 
      model_folder = paste0(root_dir,model_folder),
      prefix = "pls_", # model type, usually
      variable_ = i,
      restrict = T, # choose optimal model only form sets that are available both in Xu (new data) and Xr (calibrated)
      diss_limit = 2,
      manual = model_i
    )
   pred_out=left_join(data.frame(sample_id=BDF_frisch$sample_id),
                     data.frame(left_join(pred$predictions,pred$spc_diss),
                      model_name=pred$model_name),by="sample_id") # attaches entire column of model name, but easier to handle in workflow than single nested argument
   pred_out=tibble(sample_id=pred_out$sample_id,X=select(pred_out,-sample_id))
   names(pred_out)=c("sample_id",model_i)
   
  #pred_out=tibble(sample_id=pred_out$sample_id,data=select(pred_out,-c(sample_id)))
    # rm LQCO duplicated to enable re-merging
    pls_prediction_data=left_join(pls_prediction_data,pred_out,by="sample_id")
  }
}



### Cubist ####
model_folder="/GitHub/BDF/BDF-SSL/2_models/2_Cubist_models/"
cubist_prediction_data=tibble(BDF_frisch["sample_id"])
for (i in var_list){ 
  for (model_i in list.files(paste0(root_dir,model_folder))[
    which(str_ends(list.files(paste0(root_dir,model_folder)),i))
    ]){
    
    pred=predict_variable( 
      BDF_frisch, 
      model_folder = paste0(root_dir,model_folder),
      prefix = "cubist_", # model type, usually
      variable_ = i,
      restrict = T, # choose optimal model only form sets that are available both in Xu (new data) and Xr (calibrated)
      diss_limit = 2,
      manual = model_i
    )
   pred_out=left_join(data.frame(sample_id=BDF_frisch$sample_id),
                     data.frame(left_join(pred$predictions,pred$spc_diss),
                      model_name=pred$model_name),by="sample_id") # attaches entire column of model name, but easier to handle in workflow than single nested argument
   pred_out=tibble(sample_id=pred_out$sample_id,X=select(pred_out,-sample_id))
   names(pred_out)=c("sample_id",model_i)
   
  #pred_out=tibble(sample_id=pred_out$sample_id,data=select(pred_out,-c(sample_id)))
    # rm LQCO duplicated to enable re-merging
    cubist_prediction_data=left_join(cubist_prediction_data,pred_out,by="sample_id")
  }
}


### MBL ####
model_folder="/GitHub/BDF/BDF-SSL/2_models/4_MBL_models_frisch/"
model_folder_eval="/GitHub/BDF/BDF-SSL/2_models/3_MBL_models_test/"
mbl_prediction_data=tibble(BDF_frisch["sample_id"])
for (i in var_list){ 
  for (model_i in list.files(paste0(root_dir,model_folder))[
    which(str_ends(list.files(paste0(root_dir,model_folder)),i))
    ]){
    
    pred=predict_variable( 
      BDF_frisch, 
      model_folder = paste0(root_dir,model_folder),
      eval_model_folder=paste0(root_dir,model_folder_eval),
      prefix = "mbl_", # model type, usually
      variable_ = i,
      restrict = T, # choose optimal model only form sets that are available both in Xu (new data) and Xr (calibrated)
      diss_limit = 2,
      manual = model_i
    )
   pred_out=left_join(data.frame(sample_id=BDF_frisch$sample_id),
                     data.frame(left_join(pred$predictions,pred$spc_diss),
                      model_name=pred$model_name),by="sample_id") # attaches entire column of model name, but easier to handle in workflow than single nested argument
   pred_out=pred_out%>%group_by(sample_id)%>%summarise_all(first)
   pred_out=tibble(sample_id=pred_out$sample_id,X=select(pred_out,-sample_id))
   names(pred_out)=c("sample_id",model_i)
   
   
  #pred_out=tibble(sample_id=pred_out$sample_id,data=select(pred_out,-c(sample_id)))
    # rm LQCO duplicated to enable re-merging
    mbl_prediction_data=left_join(mbl_prediction_data,pred_out,by="sample_id")
  }
}

prediction_data_all=
  left_join(
    BDF_frisch,
    left_join(
      pls_prediction_data,
      left_join(
        cubist_prediction_data,
        mbl_prediction_data,
        by="sample_id"
      ),
      by="sample_id"
    ),
    by="sample_id"
  )

frisch_evaluation=c()
# !!! make sure not rm model column
for (model in names(prediction_data_all)[-c(1:19)]){
  data_i=tibble(obs=prediction_data_all$soliTOC[[str_split_fixed(str_split_fixed(model,"_",2)[[2]],"-",3)[3]]],
                pred=prediction_data_all[[paste0(model)]]$pred
  )
  print(model)
  
  #when in tibble argument reverts to "" when running loop
  set=str_split_fixed((str_split_fixed(model,"_",2)[[2]]),"-",3)[[1]]
  trans=str_split_fixed((str_split_fixed(model,"_",2)[[2]]),"-",3)[[2]]
  variable=str_split_fixed((str_split_fixed(model,"_",2)[[2]]),"-",3)[[3]]
  
  frisch_evaluation=rbind(frisch_evaluation,
                          tibble(model=str_split_fixed(model,"_",2)[[1]],
                                 set=set,
                                 trans=trans,
                                 variable=variable,
                                 evaluate_model_adjusted(data_i,obs=obs,pred=pred))
  )
}

write_excel_csv(frisch_evaluation,paste0(root_dir,"/GitHub/R_main/R_main/temp/all_evaluation-BDFfrisch.csv"))  

```
# OSSL spike cubist C
```{r}



### Cubist ####
model_folder="/GitHub/R_main/models/2024 models/Cubist_models_OSSL_spike/"
cubist_prediction_data_spiked=tibble(BDF_frisch["sample_id"])
for (i in var_list){ 
  for (model_i in list.files(paste0(root_dir,model_folder))[
    which(str_ends(list.files(paste0(root_dir,model_folder)),i))
    ]){
    
    pred=predict_variable( 
      BDF_frisch, 
      model_folder = paste0(root_dir,model_folder),
      prefix = "cubist_", # model type, usually
      variable_ = i,
      restrict = T, # choose optimal model only form sets that are available both in Xu (new data) and Xr (calibrated)
      diss_limit = 2,
      manual = model_i
    )
   pred_out=left_join(data.frame(sample_id=BDF_frisch$sample_id),
                     data.frame(left_join(pred$predictions,pred$spc_diss),
                      model_name=pred$model_name),by="sample_id") # attaches entire column of model name, but easier to handle in workflow than single nested argument
   pred_out=tibble(sample_id=pred_out$sample_id,X=select(pred_out,-sample_id))
   names(pred_out)=c("sample_id",model_i)
   
  #pred_out=tibble(sample_id=pred_out$sample_id,data=select(pred_out,-c(sample_id)))
    # rm LQCO duplicated to enable re-merging
    cubist_prediction_data_spiked=left_join(cubist_prediction_data_spiked,pred_out,by="sample_id")
  }
}
OSSL_spike=BDF_frisch
merge=tibble(sample_id=cubist_prediction_data$sample_id,pred=cubist_prediction_data)

spiked_merge=tibble(sample_id=cubist_prediction_data_spiked$sample_id,spiked_pred=cubist_prediction_data_spiked)
OSSL_spike%>%left_join(merge)%>%left_join(spiked_merge)->OSSL_spike

variable="ROC"
trans="none"
set="spc_sg1d_rs4"
ggplot(OSSL_spike,aes(x=soliTOC[[variable]]))+
  geom_abline(intercept=0,slope=1)+
  geom_point(aes(y=pred[[paste0("cubist_",set,"-",trans,"-",variable)]]$pred),col="black",alpha=.2)+
  geom_point(aes(y=spiked_pred[[paste0("cubist_",set,"-",trans,"-",variable)]]$pred),col="red",alpha=.2)


```



# evaluate BDFfrisch predictions (best, new)
```{r}

bind_rows(
#TC
tibble(variable="TC",evaluate_model_adjusted(data.frame(
  obs=BDF_frisch_predictions$soliTOC$TC,
  pred=BDF_frisch_predictions$mbl_predictions$TC$pred
  )%>%na.omit,obs=obs,pred=pred)),
#TOC
tibble(variable="TOC",evaluate_model_adjusted(data.frame(
  obs=BDF_frisch_predictions$soliTOC$TOC,
  pred=BDF_frisch_predictions$cubist_predictions$TOC$pred
  )%>%na.omit,obs=obs,pred=pred)),
#TOC400
tibble(variable="TOC400",evaluate_model_adjusted(data.frame(
  obs=BDF_frisch_predictions$soliTOC$TOC400,
  pred=BDF_frisch_predictions$cubist_predictions$TOC400$pred
  )%>%na.omit,obs=obs,pred=pred)),
#TC
tibble(variable="ROC",evaluate_model_adjusted(data.frame(
  obs=BDF_frisch_predictions$soliTOC$ROC,
  pred=BDF_frisch_predictions$mbl_predictions$ROC$pred
  )%>%na.omit,obs=obs,pred=pred)),
#TC
tibble(variable="TIC900",evaluate_model_adjusted(data.frame(
  obs=BDF_frisch_predictions$soliTOC$TIC900,
  pred=BDF_frisch_predictions$mbl_predictions$TIC900$pred
  )%>%na.omit,obs=obs,pred=pred))
)%>%arrange(variable)%>%View


```

# BDF frisch DRIFTS stats
```{r}
source(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/evaluate_model_adjusted.R"))

all_evaluation_full=read_rds(paste0(root_dir,"/GitHub/BDF/BDF-SSL/2_models/all_evaluation"))
out=c()
obs=c()
for (i in c("pls","cubist","mbl")){
  for (j in c("TC","TOC","TOC400","ROC","TIC900")){
    
      model=BDF_frisch_predictions[[paste0(i,"_predictions")]][[j]]$model%>%na.omit%>%unique
      
    if(str_detect(model,"log1p")){
        train_obs=exp(all_evaluation_full[[(str_split_fixed(model,"_",2))[[1]]]]$Obs_Pred_data[[model]]$train)-1
    }else if(str_detect(model,"log")){
        train_obs=exp(all_evaluation_full[[(str_split_fixed(model,"_",2))[[1]]]]$Obs_Pred_data[[model]]$train)
    }else{
        train_obs=(all_evaluation_full[[(str_split_fixed(model,"_",2))[[1]]]]$Obs_Pred_data[[model]]$train)
    }
      test_obspred=all_evaluation_full[[(str_split_fixed(model,"_",2))[[1]]]]$Obs_Pred_data[[model]]$test
      obs=rbind(obs,
                data.frame(mod=i,param=j,set="train",x=train_obs,y=NA),
                data.frame(mod=i,param=j,set="test",x=test_obspred$obs,y=test_obspred$pred),
                
                data.frame(mod=i,param=j,set="frisch",
                           x=BDF_frisch_predictions$soliTOC[[j]],
                           y=BDF_frisch_predictions[[paste0(i,"_predictions")]][[j]]$pred
       )
      )
    for (q in seq(.1,1,.1)){
      low=BDF_frisch_predictions$soliTOC[[j]]%>%quantile(q-.1,na.rm = T)
      high=BDF_frisch_predictions$soliTOC[[j]]%>%quantile(q,na.rm = T)
      sub=BDF_frisch_predictions%>%filter(soliTOC[[j]]>=low&soliTOC[[j]]<=high)
  out=rbind(
  out,
data.frame(low=low,high=high,quantile=q,mod=i,param=j,
evaluate_model_adjusted(data = data.frame(pred=sub[[paste0(i,"_predictions")]][[j]]$pred,
                                          obs=sub$soliTOC[[j]]),
                        obs="obs",pred="pred")))
    }
  }
}
out=as_tibble(out)
out%>%select(all_of(c("mod","param","rmse","nrmseavg","R2","rpd","linsCCC")))%>%arrange(param)


f=6
svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_frisch_qunatile_binnedRMSE.svg"),width = 8,height = 5)
ggplotly(ggplot(out,aes(x=(low+high)/2,y=rmse,shape=mod,col=param))+geom_point()+geom_line()+
  #geom_vline(xintercept = BDF_main$soliTOC$TC%>%na.omit()%>%quantile(.99),aes(col="TC"))+
  #geom_vline(xintercept = BDF_main$soliTOC$TOC%>%na.omit()%>%quantile(.99),aes(col="TOC"))+
  #geom_vline(xintercept = BDF_main$soliTOC$TOC400%>%na.omit()%>%quantile(.99),aes(col="TOC400"))+
  #geom_vline(xintercept = BDF_main$soliTOC$ROC%>%na.omit()%>%quantile(.99),aes(col="ROC"))+
  #geom_vline(xintercept = BDF_main$soliTOC$TIC900%>%na.omit()%>%quantile(.99),aes(col="TIC900"))+
  geom_boxplot(data=filter(obs,set=="train")%>%
                 mutate(position=case_match(param,
                                            "TOC400"~"A",
                                            "ROC"~"B",
                                            "TIC900"~"C",
                                            "TOC"~"D",
                                            "TC"~"E"                                        )),aes(y=-2/f,x=x,group=paste(position),fill=param),width=2/f,col="black")+
    geom_text(data=filter(obs,set=="train")%>%
                 mutate(position=case_match(param,
                                            "TOC400"~-2.8/f,
                                            "ROC"~-2.4/f,
                                            "TIC900"~-2/f,
                                            "TOC"~-1.6/f,
                                            "TC"~-1.2/f                                        )),aes(y=position,x=-.2,group=paste(position),label=param),hjust=1,col="black")+
  xlim(c(-.5,7.5))+ 
  xlab("Observations [M-%]")+
  ylab("RMSEP [M-%]")+
  geom_hline(yintercept = 0)+
  geom_abline(slope=.11,intercept = 0)+
  theme_pubr())
dev.off()

#zoom
svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_frisch_qunatile_binnedRMSE_zoom.svg"),width = 3,height = 2)
ggplot(out,aes(x=(low+high)/2,y=rmse,shape=mod,col=param))+geom_point()+geom_line()+
 scale_x_continuous(limits=c(0,.5),oob = scales::oob_keep)+
  scale_y_continuous(limits=c(0,.13),oob = scales::oob_keep)+
  xlab("Observations [M-%]")+
  ylab("RMSEP [M-%]")+
  geom_hline(yintercept = 0)+
  #geom_vline(xintercept = 0)+
  theme_pubr()+theme()
dev.off()

#pls
obs_pls=filter(obs,mod=="pls")
ggplot(mapping = aes(x=x,y=y,fill=param))+geom_point(data=filter(obs_pls,set=="frisch"),shape=21,alpha=.5)+
  geom_boxplot(data=filter(obs_pls,set=="train")%>%
                 mutate(position=case_match(param,
                                            "TOC400"~"A",
                                            "ROC"~"B",
                                            "TIC900"~"C",
                                            "TOC"~"D",
                                            "TC"~"E"                                        )),aes(y=-2,x=x,group=paste(position),fill=param),width=2)+
    geom_text(data=filter(obs_pls,set=="train")%>%
                 mutate(position=case_match(param,
                                            "TOC400"~-2.8,
                                            "ROC"~-2.4,
                                            "TIC900"~-2,
                                            "TOC"~-1.6,
                                            "TC"~-1.2                                        )),aes(y=position,x=-.2,group=paste(position),label=param),hjust=1)+
  xlim(c(-1,8.5))+
  xlab("Observations")+
  ylab("Predictions")+
  geom_abline(intercept = 0,slope = 1,linetype="dotted")+
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  theme_pubr()



#cubist
obs_cubist=filter(obs,mod=="cubist")
ggplot(mapping = aes(x=x,y=y,fill=param))+geom_point(data=filter(obs_cubist,set=="frisch"),shape=21,alpha=.5)+
  geom_boxplot(data=filter(obs_cubist,set=="train")%>%
                 mutate(position=case_match(param,
                                            "TOC400"~"A",
                                            "ROC"~"B",
                                            "TIC900"~"C",
                                            "TOC"~"D",
                                            "TC"~"E"                                        )),aes(y=-2,x=x,group=paste(position),fill=param),width=2)+
    geom_text(data=filter(obs_cubist,set=="train")%>%
                 mutate(position=case_match(param,
                                            "TOC400"~-2.8,
                                            "ROC"~-2.4,
                                            "TIC900"~-2,
                                            "TOC"~-1.6,
                                            "TC"~-1.2                                        )),aes(y=position,x=-.2,group=paste(position),label=param),hjust=1)+
  xlim(c(-1,8.5))+
  xlab("obs_cubistervations")+
  ylab("Predictions")+
  geom_abline(intercept = 0,slope = 1,linetype="dotted")+
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  theme_pubr()



#mbl
obs_mbl=filter(obs,mod=="mbl")
ggplot(mapping = aes(x=x,y=y,fill=param))+geom_point(data=filter(obs_mbl,set=="frisch"),shape=21,alpha=.5)+
  geom_boxplot(data=filter(obs_mbl,set=="train")%>%
                 mutate(position=case_match(param,
                                            "TOC400"~"A",
                                            "ROC"~"B",
                                            "TIC900"~"C",
                                            "TOC"~"D",
                                            "TC"~"E"                                        )),aes(y=-2,x=x,group=paste(position),fill=param),width=2)+
#   geom_vline(xintercept = quantile(filter(obs_mbl,set=="train"&param=="TC")%>%pull(x),.75)+ (quantile(filter(obs_mbl,set=="train"&param=="TC")%>%pull(x),.75)-quantile(filter(obs_mbl,set=="train"&param=="TC")%>%pull(x),.25))*1.5)+
  
    geom_text(data=filter(obs_mbl,set=="train")%>%
                 mutate(position=case_match(param,
                                            "TOC400"~-2.8,
                                            "ROC"~-2.4,
                                            "TIC900"~-2,
                                            "TOC"~-1.6,
                                            "TC"~-1.2                                        )),aes(y=position,x=-.2,group=paste(position),label=param),hjust=1)+
  xlim(c(-1,8.5))+
  xlab("Observations")+
  ylab("Predictions")+
  geom_abline(intercept = 0,slope = 1,linetype="dotted")+
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  theme_pubr()



#check train data?


```

# Prediction from DRIFTS # old
```{r}


#rewirte pred..._full$model_name->prediciton_meta[...]
# plots ####
##cubist ####
{
  svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_frisch_obs_pred_cubist.svg"),width = 3.5,height = 15)
  plot(
ggarrange(
### TC plot ####
  ggplot(BDF_frisch_predictions
         ,aes(x=soliTOC$TC,y=cubist_predictions$TC$pred))+
  geom_abline(intercept = 0,slope = 1,linetype="dotted")+
  geom_point(aes(col=sampling_data$BDF))+
  theme_pubr() +
  xlab("observed")+
  ylab("predicted")+
  xlim(c(0,7.3))+
  ylim(c(0,7.3))+
  ggtitle("TC",subtitle =BDF_frisch_predictions$cubist_predictions$TC$model_name)+
  scale_shape_manual("",breaks = c("outlier_spc", "ok"), values = c(4, 16)),
  
### TOC plot ####
ggplot(BDF_frisch_predictions,
       aes(x=soliTOC$TOC,y=cubist_predictions$TOC$pred))+
  geom_abline(intercept = 0,slope = 1,linetype="dotted")+
  geom_point(aes(col=sampling_data$BDF))+
  theme_pubr() +
  xlab("observed")+
  ylab("predicted")+
  xlim(c(0,7.3))+
  ylim(c(0,7.3))+
  ggtitle("TOC",subtitle = BDF_frisch_predictions$cubist_predictions$TOC$model_name)+
  scale_shape_manual("",breaks = c("outlier_spc", "ok"), values = c(4, 16)),
 
### TOC400 plot ####
ggplot(BDF_frisch_predictions,
       aes(x=.data$soliTOC$TOC400,y=.data$cubist_predictions$TOC400$pred))+
  geom_abline(intercept = 0,slope = 1,linetype="dotted")+
  geom_point(aes(col=sampling_data$BDF))+
  theme_pubr() +
  xlab("observed")+
  ylab("predicted")+
  xlim(c(-.01,7))+
  ylim(c(-.01,7))+
  ggtitle("TOC400",subtitle = BDF_frisch_predictions$cubist_predictions$TOC400$model_name)+
  scale_shape_manual("",breaks = c("outlier_spc", "ok"), values = c(4, 16)),

### ROC plot ####
ggplot(BDF_frisch_predictions,
       aes(x=.data$soliTOC$ROC,y=.data$cubist_predictions$ROC$pred))+
  geom_abline(intercept = 0,slope = 1,linetype="dotted")+
  geom_point(aes(col=sampling_data$BDF)) +
  theme_pubr() +
  xlab("observed")+
  ylab("predicted")+
  xlim(c(-.06,.7))+
  ylim(c(-.06,.7))+
  ggtitle("ROC",subtitle =  BDF_frisch_predictions$cubist_predictions$ROC$model_name)+
  scale_shape_manual("",breaks = c("outlier_spc", "ok"), values = c(4, 16)),

 ### TIC900 plot ####
ggplot(BDF_frisch_predictions,
       aes(x=.data$soliTOC$TIC900,y=.data$cubist_predictions$TIC900$pred))+
  geom_abline(intercept = 0,slope = 1,linetype="dotted")+
  geom_point(aes(col=sampling_data$BDF))+
  theme_pubr() +
  xlab("observed")+
  ylab("predicted")+
  xlim(c(-.02,.33))+
  ylim(c(-.02,.33))+
  ggtitle("TIC900",subtitle =  BDF_frisch_predictions$cubist_predictions$TIC900$model_name)+
  scale_shape_manual("",breaks = c("outlier_spc", "ok"), values = c(4, 16)),common.legend = T,ncol = 1
)
)
dev.off()
}

#mbl
{
  svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_frisch_obs_pred_mbl.svg"),width = 3.5,height = 15)
  plot(
ggarrange(
### TC plot ####
  ggplot(BDF_frisch_predictions
         ,aes(x=soliTOC$TC,y=mbl_predictions$TC$pred))+
  geom_abline(intercept = 0,slope = 1,linetype="dotted")+
  geom_point(aes(col=sampling_data$BDF))+
  theme_pubr() +
  xlab("observed")+
  ylab("predicted")+
  xlim(c(0,7.3))+
  ylim(c(0,7.3))+
  ggtitle("TC",subtitle =BDF_frisch_predictions$mbl_predictions$TC$model_name)+
  scale_shape_manual("",breaks = c("outlier_spc", "ok"), values = c(4, 16)),
  
### TOC plot ####
ggplot(BDF_frisch_predictions,
       aes(x=soliTOC$TOC,y=mbl_predictions$TOC$pred))+
  geom_abline(intercept = 0,slope = 1,linetype="dotted")+
  geom_point(aes(col=sampling_data$BDF))+
  theme_pubr() +
  xlab("observed")+
  ylab("predicted")+
  xlim(c(0,7.3))+
  ylim(c(0,7.3))+
  ggtitle("TOC",subtitle = BDF_frisch_predictions$mbl_predictions$TOC$model_name)+
  scale_shape_manual("",breaks = c("outlier_spc", "ok"), values = c(4, 16)),
 
### TOC400 plot ####
ggplot(BDF_frisch_predictions,
       aes(x=.data$soliTOC$TOC400,y=.data$mbl_predictions$TOC400$pred))+
  geom_abline(intercept = 0,slope = 1,linetype="dotted")+
  geom_point(aes(col=sampling_data$BDF))+
  theme_pubr() +
  xlab("observed")+
  ylab("predicted")+
  xlim(c(-.01,7))+
  ylim(c(-.01,7))+
  ggtitle("TOC400",subtitle = BDF_frisch_predictions$mbl_predictions$TOC400$model_name)+
  scale_shape_manual("",breaks = c("outlier_spc", "ok"), values = c(4, 16)),

### ROC plot ####
ggplot(BDF_frisch_predictions,
       aes(x=.data$soliTOC$ROC,y=.data$mbl_predictions$ROC$pred))+
  geom_abline(intercept = 0,slope = 1,linetype="dotted")+
  geom_point(aes(col=sampling_data$BDF)) +
  theme_pubr() +
  xlab("observed")+
  ylab("predicted")+
  xlim(c(-.06,.7))+
  ylim(c(-.06,.7))+
  ggtitle("ROC",subtitle =  BDF_frisch_predictions$mbl_predictions$ROC$model_name)+
  scale_shape_manual("",breaks = c("outlier_spc", "ok"), values = c(4, 16)),

 ### TIC900 plot ####
ggplot(BDF_frisch_predictions,
       aes(x=.data$soliTOC$TIC900,y=.data$mbl_predictions$TIC900$pred))+
  geom_abline(intercept = 0,slope = 1,linetype="dotted")+
  geom_point(aes(col=sampling_data$BDF))+
  theme_pubr() +
  xlab("observed")+
  ylab("predicted")+
  xlim(c(-.02,.33))+
  ylim(c(-.02,.33))+
  ggtitle("TIC900",subtitle =  BDF_frisch_predictions$mbl_predictions$TIC900$model_name)+
  scale_shape_manual("",breaks = c("outlier_spc", "ok"), values = c(4, 16)),common.legend = T,ncol = 1
)
)
dev.off()
}


{
  svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_frisch_obs_pred_pls.svg"),width = 3.5,height = 15)
  plot(
ggarrange(
### TC plot ####
  ggplot(BDF_frisch_predictions
         ,aes(x=soliTOC$TC,y=pls_predictions$TC$pred))+
  geom_abline(intercept = 0,slope = 1,linetype="dotted")+
  geom_point(aes(col=sampling_data$BDF))+
  theme_pubr() +
  xlab("observed")+
  ylab("predicted")+
  xlim(c(0,7.3))+
  ylim(c(0,7.3))+
  ggtitle("TC",subtitle =BDF_frisch_predictions$pls_predictions$TC$model_name)+
  scale_shape_manual("",breaks = c("outlier_spc", "ok"), values = c(4, 16)),
  
### TOC plot ####
ggplot(BDF_frisch_predictions,
       aes(x=soliTOC$TOC,y=pls_predictions$TOC$pred))+
  geom_abline(intercept = 0,slope = 1,linetype="dotted")+
  geom_point(aes(col=sampling_data$BDF))+
  theme_pubr() +
  xlab("observed")+
  ylab("predicted")+
  xlim(c(0,7.3))+
  ylim(c(0,7.3))+
  ggtitle("TOC",subtitle = BDF_frisch_predictions$pls_predictions$TOC$model_name)+
  scale_shape_manual("",breaks = c("outlier_spc", "ok"), values = c(4, 16)),
 
### TOC400 plot ####
ggplot(BDF_frisch_predictions,
       aes(x=.data$soliTOC$TOC400,y=.data$pls_predictions$TOC400$pred))+
  geom_abline(intercept = 0,slope = 1,linetype="dotted")+
  geom_point(aes(col=sampling_data$BDF))+
  theme_pubr() +
  xlab("observed")+
  ylab("predicted")+
  xlim(c(-.01,7))+
  ylim(c(-.01,7))+
  ggtitle("TOC400",subtitle = BDF_frisch_predictions$pls_predictions$TOC400$model_name)+
  scale_shape_manual("",breaks = c("outlier_spc", "ok"), values = c(4, 16)),

### ROC plot ####
ggplot(BDF_frisch_predictions,
       aes(x=.data$soliTOC$ROC,y=.data$pls_predictions$ROC$pred))+
  geom_abline(intercept = 0,slope = 1,linetype="dotted")+
  geom_point(aes(col=sampling_data$BDF)) +
  theme_pubr() +
  xlab("observed")+
  ylab("predicted")+
  xlim(c(-.06,.7))+
  ylim(c(-.06,.7))+
  ggtitle("ROC",subtitle =  BDF_frisch_predictions$pls_predictions$ROC$model_name)+
  scale_shape_manual("",breaks = c("outlier_spc", "ok"), values = c(4, 16)),

 ### TIC900 plot ####
ggplot(BDF_frisch_predictions,
       aes(x=.data$soliTOC$TIC900,y=.data$pls_predictions$TIC900$pred))+
  geom_abline(intercept = 0,slope = 1,linetype="dotted")+
  geom_point(aes(col=sampling_data$BDF))+
  theme_pubr() +
  xlab("observed")+
  ylab("predicted")+
  xlim(c(-.02,.33))+
  ylim(c(-.02,.33))+
  ggtitle("TIC900",subtitle =  BDF_frisch_predictions$pls_predictions$TIC900$model_name)+
  scale_shape_manual("",breaks = c("outlier_spc", "ok"), values = c(4, 16)),common.legend = T,ncol = 1
)
)
dev.off()
}


### TOC plot ####
ggplot(BDF_frisch_predictions%>%left_join(BDF_frisch_SAMPLE_LIST[-7,],by=c("sample_id"="Proben_ID")),aes(x=.data$soliTOC$TOC,y=.data$predictions$TOC$pred))+
  geom_abline(intercept = 0,slope = 1,linetype="dotted")+
 geom_point(aes(col=.data$predictions$TOC$mean_diss,shape=if_else(is.na(BDF_frisch_predictions$predictions$TOC$diss_flag),"ok",BDF_frisch_predictions$predictions$TOC$diss_flag)))+
  theme_pubr() +
  scale_color_steps(low = "blue", high = "red")+
  scale_shape_manual(breaks = c("outlier_spc", "ok"), values = c(4, 16)) #+
  scale_size_manual(breaks = c("outlier_spc", "ok"), values = c(3, 1))

### ROC plot ####
ggplot(BDF_frisch_predictions%>%left_join(BDF_frisch_SAMPLE_LIST[-7,],by=c("sample_id"="Proben_ID")),aes(x=.data$soliTOC$ROC,y=.data$predictions$ROC$pred))+
  geom_abline(intercept = 0,slope = 1,linetype="dotted")+
  geom_point(aes(col=.data$predictions$ROC$mean_diss,shape=if_else(is.na(BDF_frisch_predictions$predictions$ROC$diss_flag),"ok",BDF_frisch_predictions$predictions$ROC$diss_flag)))+
  theme_pubr() +
  scale_color_steps(low = "blue", high = "red")+
  scale_shape_manual(breaks = c("outlier_spc", "ok"), values = c(4, 16)) #+
  scale_size_manual(breaks = c("outlier_spc", "ok"), values = c(3, 1))

  ### TIC900 plot ####
ggplot(BDF_frisch_predictions%>%left_join(BDF_frisch_SAMPLE_LIST[-7,],by=c("sample_id"="Proben_ID")),aes(x=.data$soliTOC$TIC900,y=.data$predictions$TIC900$pred))+
  geom_abline(intercept = 0,slope = 1,linetype="dotted")+
  geom_point(aes(col=.data$predictions$TIC900$mean_diss,shape=if_else(is.na(BDF_frisch_predictions$predictions$TIC900$diss_flag),"ok",BDF_frisch_predictions$predictions$TIC900$diss_flag)))+
  theme_pubr() +
  scale_color_steps(low = "blue", high = "red")+
  scale_shape_manual(breaks = c("outlier_spc", "ok"), values = c(4, 16)) #+
  scale_size_manual(breaks = c("outlier_spc", "ok"), values = c(3, 1))
}
```



# Depth plots of predictions
```{r}

UNITS <- read_csv(paste0(root_dir,"/GitHub/BDF/BDF-SSL/5_Provided_BDF_Database/Adam-2024_UBoden-UNITS_lookup.csv"))
for (var_ in c("TOC400","ROC","TIC900","TOC","TC")
){

  model=filter(all_evaluation_best_rmse,variable==var_)%>%pull(model)
  model_name=paste0(filter(all_evaluation_best_rmse,variable==var_)%>%pull(model),"_",filter(all_evaluation_best_rmse,variable==var_)%>%pull(set),"-",filter(all_evaluation_best_rmse,variable==var_)%>%pull(trans))

svg(paste0(root_dir,"/GitHub/R_main/R_main/temp/BDF_frisch_",var_,"_predictied_profiles.svg"),width = 3,height = 13)
print(var_)
plot(  
BDF_frisch_predictions%>%mutate(BDF=sampling_data$BDF)%>%filter(sample_id%>%substr(2,2)%in%c("R","Q","P")&sampling_data$Tiefe_von>=0) %>% mutate(Tiefe=(sampling_data$Tiefe_bis+sampling_data$Tiefe_von)/2)%>%
ggplot(
      )+
    #manual gridlines
 #   geom_hline(yintercept = seq(.6,2.8,.1),col="grey15",linewidth=.025)+
  #  geom_vline(xintercept = seq(0,150,10),col="grey15",linewidth=.025)+
   # geom_vline(xintercept = 0,linewidth=.2,col="black")+
# obs  
    geom_line(
              aes(x=Tiefe,
                  y=soliTOC[[var_]],
                  col="soliTOC",
                  linetype=sampling_data$Typ,
                  group=paste(sampling_data$BDF,sampling_data$Position,sampling_data$Typ)),
              linewidth=.1,alpha=.5
             )+
  geom_smooth(
              aes(x=Tiefe,
                  y=soliTOC[[var_]],
                  col="soliTOC",
                  linetype=sampling_data$Typ,
                  group=paste(sampling_data$BDF,sampling_data$Typ)
                  ),
              linewidth=1,
             se=F)+

  
# pred
    geom_line(
      aes(
        x=Tiefe,
        y=.data[[paste0(model,"_predictions")]][[var_]]$pred,
                linetype=sampling_data$Typ,
        col="DRIFTS",
        group=paste(sampling_data$BDF,sampling_data$Position,sampling_data$Typ)),
              linewidth=.1)+
    geom_smooth(
        aes(
        x=Tiefe,
        y=.data[[paste0(model,"_predictions")]][[var_]]$pred,
                linetype=sampling_data$Typ,
        col="DRIFTS",
        group=paste(sampling_data$BDF,sampling_data$Typ)),
        se=F
    )+ 
     
  
  #formatting
    coord_flip()+
    scale_x_reverse("Tiefe [cm]",
                    breaks=seq(0,150,50),
                    minor_breaks=seq(0,150,10))+
    #scale_color_manual(breaks=c("02","23","30","35"),values=colorblind_safe_colors[c(2:4,8)],labels=paste("BDF",c("02","23","30","35")))+
    scale_linetype_manual("",
                          breaks=c("Profilspaten","Quicksampler","Rammkern"),
                          values=c("dotdash","dashed","dotted"),
                          labels=c("PS","QS","RK"))+

    scale_color_manual("",
                       breaks=c("soliTOC","DRIFTS"),
                       values = c(colorblind_safe_colors[c(7,1)],"black","black","black"),
                       labels=c("soliTOC","DRIFTS"))+
    ylab(paste0(var_," [M-%]"))+
    theme_pubr()+
    theme(legend.box="vertical",strip.text = element_text(size=8)
          #legend.position = "top"
          #panel.grid = element_line(colour = "grey"),
          #panel.grid.major = element_line(colour = "grey",linewidth = 1),
          #panel.grid.minor = element_line(colour = "grey",linewidth = 1,linetype = "solid")
          )+ggtitle("",subtitle = model_name)+
  facet_wrap(facets = vars(BDF),labeller = BDF_labeller,scales = "free",ncol = 1)
)
dev.off()
}
```








```{r}

# vars no reference available ####
UNITS <- read_csv(paste0(root_dir,"/GitHub/BDF/BDF-SSL/5_Provided_BDF_Database/Adam-2024_UBoden-UNITS_lookup.csv"))
for (var_ in c(
  "CORG","T","U","S","KAKpot","Nt"
)
){
  model=filter(all_evaluation_best_rmse,variable==var_)%>%pull(model)
  model_name=paste0(filter(all_evaluation_best_rmse,variable==var_)%>%pull(model),"_",filter(all_evaluation_best_rmse,variable==var_)%>%pull(set),"-",filter(all_evaluation_best_rmse,variable==var_)%>%pull(trans))

svg(paste0(root_dir,"/GitHub/BDF/BDF-SSL/3_r_scripts/temp/BDF_frisch_",var_,"_predictied_profiles.svg"),width = 3,height = 13)
print(var_)
plot(  
BDF_frisch_predictions%>%mutate(BDF=sampling_data$BDF)%>%filter(sample_id%>%substr(2,2)%in%c("R","Q","P")&sampling_data$Tiefe_von>=0) %>% mutate(Tiefe=(sampling_data$Tiefe_bis+sampling_data$Tiefe_von)/2)%>%
ggplot(
      )+
    #manual gridlines
 #   geom_hline(yintercept = seq(.6,2.8,.1),col="grey15",linewidth=.025)+
  #  geom_vline(xintercept = seq(0,150,10),col="grey15",linewidth=.025)+
   # geom_vline(xintercept = 0,linewidth=.2,col="black")+
# 


# pred
    geom_line(
      aes(
        x=Tiefe,
        y=.data[[paste0(model,"_predictions")]][[var_]]$pred,
                linetype=sampling_data$Typ,
        col="DRIFTS",
        group=paste(sampling_data$BDF,sampling_data$Position,sampling_data$Typ)),
              linewidth=.1)+
    geom_smooth(
        aes(
        x=Tiefe,
        y=.data[[paste0(model,"_predictions")]][[var_]]$pred,
                linetype=sampling_data$Typ,
        col="DRIFTS",
        group=paste(sampling_data$BDF,sampling_data$Typ)),
        se=F
    )+ 
     
     geom_line(data = filter(Lagerungsdichte_Referenz,Tiefe<100),
              aes(x=Tiefe,
                  y=.data[[var_]], # 10e-2 g/cm³ | 1ha =10e8 cm² , 1 T = 10^6 g -> 1 10^-2g/cm³ = 1 T/ha*cm
                  col="BDF-Referenz",
                  linetype="BDF-Referenz"
                  ),
              linewidth=1,
             )+
  #formatting
    coord_flip()+
    scale_x_reverse("Tiefe [cm]",
                    breaks=seq(0,150,50),
                    minor_breaks=seq(0,150,10))+
    #scale_color_manual(breaks=c("02","23","30","35"),values=colorblind_safe_colors[c(2:4,8)],labels=paste("BDF",c("02","23","30","35")))+
    scale_linetype_manual("",
                          breaks=c("Profilspaten","Quicksampler","Rammkern","BDF-Referenz"),
                          values=c("dotdash","dashed","dotted","solid"),
                          labels=c("PS","QS","RK","BDF"))+

    scale_color_manual("",
                       breaks=c("BDF-Referenz","DRIFTS"),
                       values = c(colorblind_safe_colors[c(6,7)],"black","black","black"),
                       labels=c("Referenz","DRIFTS"))+
    ylab(paste0(var_," [M-%]"))+
    theme_pubr()+
    theme(legend.box="vertical",strip.text = element_text(size=8)
          #legend.position = "top"
          #panel.grid = element_line(colour = "grey"),
          #panel.grid.major = element_line(colour = "grey",linewidth = 1),
          #panel.grid.minor = element_line(colour = "grey",linewidth = 1,linetype = "solid")
          )+ggtitle("",subtitle = model_name)+
  facet_wrap(facets = vars(BDF),labeller = BDF_labeller,scales = "free",ncol = 1)
)
dev.off()
}

```


```{r}







paste(BDF,Position,Typ){
  
  
    ggplot(
      aes(
        x=(sampling_data$Tiefe_bis+sampling_data$Tiefe_von)/2,
        y=.data[[paste0(model,"_predictions")]][[variable]]$pred,
        linetype=sampling_data$Typ,
        alpha=sampling_data$Typ,
        #col=sampling_data$BDF
        ))+
    #manual gridlines
    #geom_hline(yintercept = seq(0,6,.25),col="grey15",linewidth=.025)+
    geom_vline(xintercept = seq(0,150,10),col="grey15",linewidth=.025)+
    geom_vline(xintercept = 0,linewidth=.2,col="black")+
    geom_line(aes(group=paste(sampling_data$BDF,sampling_data$Position,sampling_data$Typ),
                  #col=sampling_data$BDF
                  ),linewidth=.1,alpha=0.1)+
    geom_smooth(aes(alpha=paste("Mittel",sampling_data$Typ)),se=F,linewidth=1,col="black"
                  )->plt
  if(variable%in%c("TOC400","ROC","TIC900","TOC","TC")){
    plt+
    geom_line(aes(group=paste(sampling_data$BDF,sampling_data$Position,sampling_data$Typ),
                  y=soliTOC[[variable]],
                  text="Referenz"),
                   alpha=0.1,#paste("Referenz",sampling_data$Typ)),
                 col="darkblue"
    )+geom_smooth(aes(y=soliTOC[[variable]],
                  #col=sampling_data$BDF,
                  linetype="Referenz",
                  alpha=paste("Mittel",sampling_data$Typ)),se=F,
                 col="darkblue",
              linewidth=1
             )+
        coord_flip()+
    scale_x_reverse("Tiefe [cm]",breaks=seq(0,150,50),minor_breaks=seq(0,150,10))+
    #scale_color_manual(breaks=c("02","23","30","35"),values=colorblind_safe_colors[c(2:4,8)],labels=paste("BDF",c("02","23","30","35")))+
    scale_linetype_manual("",breaks=c("Referenz","Profilspaten","Quicksampler","Rammkern"),
                          values=c("solid","dotdash","dashed","dotted"),
                          labels=c("Referenz","PS","QS","RK"))+
    scale_alpha_manual("",breaks=c("Mittel Profilspaten","Mittel Quicksampler","Mittel Rammkern",
                                   "Referenz Profilspaten","Referenz Quicksampler","Referenz Rammkern",
                                   "Profilspaten","Quicksampler","Rammkern"),
                       values=c(rep(.5,6),1,1,1,1),
                      # labels=c("Mittel PS","Mittel QS","Mittel RK","PS","QS","RK")
                      )+
   # scale_color_manual("",breaks=c("02","23","30","35"),values = colorblind_safe_colors[c(2:4,8)],labels=c("BDF02","BDF23","BDF30","BDF35"))+
    scale_y_continuous(paste(variable, UNITS$unit[which(UNITS$variable==variable)]))+
    theme_pubr()+
    theme(legend.box="vertical",
          #legend.position = "top"
          panel.grid = element_line(colour = "grey"),
          panel.grid.major = element_line(colour = "grey",linewidth = 1),
          panel.grid.minor = element_line(colour = "grey",linewidth = 1,linetype = "solid")
          )+
  facet_wrap(facets = vars(BDF=sampling_data$BDF),labeller = BDF_labeller,scales = "free",nrow = 1)
}
  }
  
  MN=BDF_frisch_predictions%>%
    filter(sample_id%>%substr(2,2)%in%c("R","Q","P")&sampling_data$Tiefe_von>=0)%>%
    mutate(x=(sampling_data$Tiefe_bis+sampling_data$Tiefe_von)/2)%>%
                group_by(x,sampling_data$BDF,sampling_data$Typ)%>%
    summarise(pred_MN=mean(.[[paste0(model,"_predictions")]][[variable]]$pred,na.rm = T))
  MN$sampling_data=tibble(Typ=MN$`sampling_data$Typ`,BDF=MN$`sampling_data$BDF`)
  MN=select(ungroup(MN),!c(`sampling_data$Typ`,`sampling_data$BDF`))
  ggplotly(
    plt+#geom_line(data=MN,aes(x=x,y=pred_MN,alpha=sampling_data$Typ,),col="red3")+
    coord_flip()+
    scale_x_reverse("Tiefe [cm]",breaks=seq(0,150,50),minor_breaks=seq(0,150,10))+
    #scale_color_manual(breaks=c("02","23","30","35"),values=colorblind_safe_colors[c(2:4,8)],labels=paste("BDF",c("02","23","30","35")))+
    scale_linetype_manual("",breaks=c("Referenz","Profilspaten","Quicksampler","Rammkern"),
                          values=c("solid","dotdash","dashed","dotted"),
                          labels=c("Referenz","PS","QS","RK"))+
    scale_alpha_manual("",breaks=c("Mittel Profilspaten","Mittel Quicksampler","Mittel Rammkern",
                                   "Referenz Profilspaten","Referenz Quicksampler","Referenz Rammkern",
                                   "Profilspaten","Quicksampler","Rammkern"),
                       values=c(rep(.5,6),1,1,1,1),
                      # labels=c("Mittel PS","Mittel QS","Mittel RK","PS","QS","RK")
                      )+
   # scale_color_manual("",breaks=c("02","23","30","35"),values = colorblind_safe_colors[c(2:4,8)],labels=c("BDF02","BDF23","BDF30","BDF35"))+
    scale_y_continuous(paste(variable, UNITS$unit[which(UNITS$variable==variable)]))+
    theme_pubr()+
    theme(legend.box="vertical",
          #legend.position = "top"
          panel.grid = element_line(colour = "grey"),
          panel.grid.major = element_line(colour = "grey",linewidth = 1),
          panel.grid.minor = element_line(colour = "grey",linewidth = 1,linetype = "solid")
          )+
  facet_wrap(facets = vars(BDF=sampling_data$BDF),labeller = BDF_labeller,scales = "free",nrow = 1#,labeller = function(x){paste("BDF",x)}
             )
)%>%layout(legend=list(x=0,
                       y=-.20,
                       xanchor='left',
                       yanchor='bottom',
                       orientation='h'))

}





(ggplot(BDF_frisch_predictions%>%filter(sampling_data$BDF=="30")
                                                                                    ,aes(x=soliTOC$TIC900,y=cubist_predictions$TIC900$pred))+
      geom_abline(intercept = 0,slope = 1,linetype="dotted")+
      geom_point(aes(col=sampling_data$BDF,fill=sampling_data$Typ%>%as.character()),shape=21)+
    geom_point(data=filter(BDF_frisch_predictions,soliTOC$TC>cubist_predictions$TC$pred+1),shape=4)+
    
      theme_pubr() +
      xlab("observed")+
      ylab("predicted")+
      ggtitle("TC",subtitle =BDF_frisch_predictions$cubist_predictions$TC$model_name)+geom_abline(intercept = -1,slope=1))%>%ggplotly
```











# PCA MAIN FRISCH
```{r}
Xr=BDF_main$spc_sg_snv
rownames(Xr)<-BDF_main$sample_id


Xu=BDF_frisch$spc_sg_snv
rownames(Xu)<-BDF_frisch$sample_id

full_diss=dissimilarity(Xr=Xr,,Xu=Xu,diss_method = "pca.nipals",return_projection = T,
  )



full_diss$projection$scores%>%data.frame()%>%rownames_to_column()%>%mutate(set=rowname%>%substr(1,2))%>%cbind(data.frame(BDF=c(BDF_main$BDF_database$Projekt%>%substr(4,5),BDF_frisch$sampling_data$BDF)))%>%mutate(Nutzung=c(BDF_main$BDF_database$Nutzung,rep(NA,462)),sample_id=c(rownames(Xr),rownames(Xu))
)%>%
  mutate(Nutzung=case_when(
    set=="Xr"~Nutzung,
    set=="Xu"&BDF=="02"~"A",
    set=="Xu"&BDF=="23"~"A",
    set=="Xu"&BDF=="30"~"G",
    set=="Xu"&BDF=="35"~"A"),
    Tiefe=c(BDF_main$BDF_database$untere.Probentiefe,BDF_frisch$sampling_data$Tiefe_von))->pca_data

  
  
 #( ggplot(aes(x=pc_1,y=pc_2,col=Nutzung,shape=set))+geom_point(alpha=.5,aes(text=paste(BDF,sample_id))))%>%ggplotly
plot_ly(data = pca_data,x=~pc_1,y=~pc_2,z=~pc_3,color = ~set,symbol = ~Nutzung,text=~paste(BDF,Tiefe))




```








